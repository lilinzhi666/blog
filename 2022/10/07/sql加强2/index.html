<!DOCTYPE HTML>
<html lang="zh_CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="sql加强2, lilinzhi">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>sql加强2 | lilinzhi</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="lilinzhi" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">lilinzhi</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/music" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>music</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">lilinzhi</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/music" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			music
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">sql加强2</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/SQL%E5%BC%BA%E5%8C%962/">
                                <span class="chip bg-color">SQL强化2</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-10-07
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="SQL强化"><a href="#SQL强化" class="headerlink" title="SQL强化"></a>SQL强化</h1><h2 id="SQL执行顺序"><a href="#SQL执行顺序" class="headerlink" title="SQL执行顺序"></a>SQL执行顺序</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--举例：</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">       a.sex,</span><br><span class="line">       b.city,</span><br><span class="line">       <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt,</span><br><span class="line">       <span class="built_in">sum</span>(salary) <span class="keyword">as</span> sum1</span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line"><span class="keyword">join</span> table2 b <span class="keyword">on</span> a.id<span class="operator">=</span>b.id</span><br><span class="line"><span class="keyword">where</span> a.name<span class="operator">=</span>b.name</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.sex,b.city</span><br><span class="line"><span class="keyword">having</span> cnt<span class="operator">&gt;=</span><span class="number">2</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a.sex,b.city</span><br><span class="line">limit <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--或者是</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span></span><br><span class="line">       a.sex,</span><br><span class="line">       b.city,</span><br><span class="line">       a.age</span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line"><span class="keyword">join</span> table2 b <span class="keyword">on</span> a.id<span class="operator">=</span>b.id</span><br><span class="line"><span class="keyword">where</span> a.name<span class="operator">=</span>b.name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a.sex,b.city</span><br><span class="line">limit <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面的SQL语句的执行顺序是: from (去加载table1 和 table2这2个表 )  -&gt; join -&gt; on -&gt; where  -&gt; group by-&gt;select 后面的聚合函数count,sum  -&gt; having -&gt; distinct -&gt; order by -&gt; limit</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--on 和where的先后顺序讨论</span></span><br><span class="line"><span class="comment">--下面用left join 各得到结果，结果不一样。</span></span><br><span class="line"><span class="comment">--下面可知，先执行on，再执行where</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> table2 b </span><br><span class="line"><span class="keyword">on</span> a.id<span class="operator">=</span>b.id</span><br><span class="line"><span class="keyword">where</span> a.name<span class="operator">=</span>b.name;</span><br><span class="line"><span class="comment">--下面的条数可能会比上面多。</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> table2 b </span><br><span class="line"><span class="keyword">on</span> a.id<span class="operator">=</span>b.id</span><br><span class="line"><span class="keyword">and</span> a.name<span class="operator">=</span>b.name;</span><br><span class="line"></span><br><span class="line"><span class="comment">--下面用inner join 各得到结果，结果是一样的</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line"><span class="keyword">join</span> table2 b </span><br><span class="line"><span class="keyword">on</span> a.id<span class="operator">=</span>b.id</span><br><span class="line"><span class="keyword">where</span> a.name<span class="operator">=</span>b.name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> table1 a</span><br><span class="line"><span class="keyword">join</span> table2 b </span><br><span class="line"><span class="keyword">on</span> a.id<span class="operator">=</span>b.id</span><br><span class="line"><span class="keyword">and</span> a.name<span class="operator">=</span>b.name;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>hivesql与sparkSQL的区别：</p>
<ul>
<li><p>子查询hive必须起别名，SparkSQL可以不用起别名</p>
</li>
<li><p>group by xx，yy，hive不用能用别名，spark可以用别名</p>
</li>
<li><p>hive不支持临时视图和缓存表，SparkSQL都支持</p>
<ul>
<li>&#96;&#96;&#96;sql<br>–用SparkSQL的临时视图<br> use interview_db;<br> create or replace temporary view t_view1 as<br> select *,<br> if(month&#x3D;1,amount,0) as a1,<br> if(month&#x3D;2,amount,0) as a2,<br> if(month&#x3D;3,amount,0) as a3,<br> if(month&#x3D;4,amount,0) as a4<br> from table2;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>select year,<br>sum(a1) as m1,<br>sum(a2) as m2,<br>sum(a3) as m3,<br>sum(a4) as m4<br>from t_view1<br>group by year;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>&#96;&#96;&#96;sql</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>–使用SparkSQL的缓存表<br>cache table cached1 as<br>select *,<br>if(month&#x3D;1,amount,0) as a1,<br>if(month&#x3D;2,amount,0) as a2,<br>if(month&#x3D;3,amount,0) as a3,<br>if(month&#x3D;4,amount,0) as a4<br>from table2;</p>
<p>select * from cached1;<br>select year,<br>sum(a1) as m1,<br>sum(a2) as m2,<br>sum(a3) as m3,<br>sum(a4) as m4<br>from cached1<br>group by year;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 爆炸函数，hive不支持explode与普通字段联合使用，需要用侧视图分开，SparkSQL支持联合使用</span><br><span class="line"></span><br><span class="line">  * ```sql</span><br><span class="line">    sql</span><br><span class="line">     use interview_db;</span><br><span class="line">     select qq,game1 from tableB lateral view explode(split(game,&#x27;_&#x27;)) view1 as game1 ;</span><br><span class="line">     --spark还支持这样，但是hive不支持：</span><br><span class="line">     select qq,explode(split(game,&#x27;_&#x27;)) game1 from tableB ;</span><br></pre></td></tr></table></figure>

  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">* sparkSQL支持300多种函数，hiveSQL支持200多种函数。sparkSQL函数比hiveSQL要多。</span><br><span class="line"></span><br><span class="line">  * 比如SparkSQL有sequence函数，hive就没有</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="hive10题"><a href="#hive10题" class="headerlink" title="hive10题"></a>hive10题</h2><ul>
<li><p>先配置环境</p>
</li>
<li><p>在pycharm或datagrip或idea中配置hive数据源。也可以配置一个sparkSQL数据源，来加快速度。</p>
</li>
<li><p>如果配置hive数据源：</p>
<ul>
<li><p>需要提前启动hdfs和yarn，hive的metastore，hive的hiveserver2</p>
</li>
<li><p>&#96;&#96;&#96;shell<br>#启动hdfs和yarn<br>start-all.sh  </p>
<h1 id="hive的metastore"><a href="#hive的metastore" class="headerlink" title="hive的metastore"></a>hive的metastore</h1><p>nohup &#x2F;export&#x2F;server&#x2F;hive&#x2F;bin&#x2F;hive –service metastore  2&gt;&amp;1 &gt; &#x2F;tmp&#x2F;hive-metastore.log &amp;</p>
<p>#hive的hiveserver2<br>#hiveserver2开启后，等过2分钟后才能生效。<br>nohup &#x2F;export&#x2F;server&#x2F;hive&#x2F;bin&#x2F;hive –service hiveserver2 2&gt;&amp;1 &gt; &#x2F;tmp&#x2F;hive-hiveserver2.log &amp;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ![1659774353515](E:\自研项目\sql资料\4\images\1659774353515.png)</span><br><span class="line"></span><br><span class="line">* 如果遇到下面的问题</span><br><span class="line"></span><br><span class="line">* ![1659749246129](E:\自研项目\sql资料\4\images\1659749246129.png)</span><br><span class="line"></span><br><span class="line">* 解决办法</span><br><span class="line"></span><br><span class="line">  * ```</span><br><span class="line">    hive/conf/hive-env.sh中加入</span><br><span class="line">    export HADOOP_CLIENT_OPTS=&quot; -Xmx512m&quot;</span><br><span class="line">    export HADOOP_HEAPSIZE=1024</span><br><span class="line">    改完重启hiveserver2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>如果配置SparkSQL数据源</p>
<ul>
<li><p>需要提前启动hdfs，hive的metastore，Spark的Thriftserver服务。</p>
</li>
<li><p>&#96;&#96;&#96;shell<br>#启动hdfs和yarn<br>start-all.sh  </p>
<h1 id="hive的metastore-1"><a href="#hive的metastore-1" class="headerlink" title="hive的metastore"></a>hive的metastore</h1><p>nohup &#x2F;export&#x2F;server&#x2F;hive&#x2F;bin&#x2F;hive –service metastore  2&gt;&amp;1 &gt; &#x2F;tmp&#x2F;hive-metastore.log &amp;</p>
<p>#Spark的Thriftserver服务<br>&#x2F;export&#x2F;server&#x2F;spark&#x2F;sbin&#x2F;start-thriftserver.sh <br>  –hiveconf hive.server2.thrift.port&#x3D;10001 <br>  –hiveconf hive.server2.thrift.bind.host&#x3D;node1 <br>  –master local[*]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  * 下面是spark3集成hive3需要的jar包，如果是spark2集成hive2，则jar包不一样。![1659774447157](E:\自研项目\sql资料\4\images\1659774447157.png)</span><br><span class="line"></span><br><span class="line">  * ![1659774468920](E:\自研项目\sql资料\4\images\1659774468920.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```sql</span><br><span class="line">show databases ;</span><br><span class="line">create database if not exists test_sql;</span><br><span class="line">use test_sql;</span><br><span class="line">-- 一些语句会走 MapReduce，所以慢。 可以开启本地化执行的优化。</span><br><span class="line">set hive.exec.mode.local.auto=true;-- (默认为false)</span><br><span class="line">--第1题：访问量统计</span><br><span class="line">CREATE TABLE test_sql.test1 (</span><br><span class="line">		userId string,</span><br><span class="line">		visitDate string,</span><br><span class="line">		visitCount INT )</span><br><span class="line">	ROW format delimited FIELDS TERMINATED BY &quot;\t&quot;;</span><br><span class="line"></span><br><span class="line">INSERT overwrite TABLE test_sql.test1</span><br><span class="line">VALUES</span><br><span class="line">    ( &#x27;u01&#x27;, &#x27;2017/1/21&#x27;, 5 ),</span><br><span class="line">    ( &#x27;u02&#x27;, &#x27;2017/1/23&#x27;, 6 ),</span><br><span class="line">    ( &#x27;u03&#x27;, &#x27;2017/1/22&#x27;, 8 ),</span><br><span class="line">    ( &#x27;u04&#x27;, &#x27;2017/1/20&#x27;, 3 ),</span><br><span class="line">    ( &#x27;u01&#x27;, &#x27;2017/1/23&#x27;, 6 ),</span><br><span class="line">    ( &#x27;u01&#x27;, &#x27;2017/2/21&#x27;, 8 ),</span><br><span class="line">    ( &#x27;u02&#x27;, &#x27;2017/1/23&#x27;, 6 ),</span><br><span class="line">    ( &#x27;u01&#x27;, &#x27;2017/2/22&#x27;, 4 );</span><br><span class="line"></span><br><span class="line">select *,</span><br><span class="line">       sum(sum1) over(partition by userid order by month1 /*rows between unbounded preceding and current row*/ ) as `累积`</span><br><span class="line"> from</span><br><span class="line">(select userid,</span><br><span class="line">       date_format(replace(visitdate,&#x27;/&#x27;,&#x27;-&#x27;),&#x27;yyyy-MM&#x27;) as month1,</span><br><span class="line">       sum(visitcount) sum1</span><br><span class="line">from test_sql.test1</span><br><span class="line">group by userid,</span><br><span class="line">         date_format(replace(visitdate,&#x27;/&#x27;,&#x27;-&#x27;),&#x27;yyyy-MM&#x27;)) as t;</span><br><span class="line"></span><br><span class="line">-- 第2题：电商场景TopK统计</span><br><span class="line">CREATE TABLE test_sql.test2 (</span><br><span class="line">						 user_id string,</span><br><span class="line">						 shop string )</span><br><span class="line">			ROW format delimited FIELDS TERMINATED BY &#x27;\t&#x27;;</span><br><span class="line">INSERT INTO TABLE test_sql.test2 VALUES</span><br><span class="line">( &#x27;u1&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u2&#x27;, &#x27;b&#x27; ),</span><br><span class="line">( &#x27;u1&#x27;, &#x27;b&#x27; ),</span><br><span class="line">( &#x27;u1&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u3&#x27;, &#x27;c&#x27; ),</span><br><span class="line">( &#x27;u4&#x27;, &#x27;b&#x27; ),</span><br><span class="line">( &#x27;u1&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u2&#x27;, &#x27;c&#x27; ),</span><br><span class="line">( &#x27;u5&#x27;, &#x27;b&#x27; ),</span><br><span class="line">( &#x27;u4&#x27;, &#x27;b&#x27; ),</span><br><span class="line">( &#x27;u6&#x27;, &#x27;c&#x27; ),</span><br><span class="line">( &#x27;u2&#x27;, &#x27;c&#x27; ),</span><br><span class="line">( &#x27;u1&#x27;, &#x27;b&#x27; ),</span><br><span class="line">( &#x27;u2&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u2&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u3&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u5&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u5&#x27;, &#x27;a&#x27; ),</span><br><span class="line">( &#x27;u5&#x27;, &#x27;a&#x27; );</span><br><span class="line">--（1）每个店铺的UV（访客数）</span><br><span class="line">-- UV和PV</span><br><span class="line">-- PV是访问当前网站所有的次数</span><br><span class="line">-- UV是访问当前网站的客户数(需要去重)</span><br><span class="line">--(2)每个店铺访问次数top3的访客信息。输出店铺名称、访客id、访问次数</span><br><span class="line">select shop,</span><br><span class="line">       count(distinct user_id) as uv</span><br><span class="line">from test_sql.test2 group by shop ;</span><br><span class="line">--上面的拆解来看，等价于</span><br><span class="line">--distinct后可以接多个字段，表示联合去重</span><br><span class="line">select shop,</span><br><span class="line">       count(user_id) as uv</span><br><span class="line">from</span><br><span class="line">(select distinct shop,</span><br><span class="line">        user_id</span><br><span class="line">from test_sql.test2  ) as t</span><br><span class="line">group by shop ;</span><br><span class="line">--也等价于</span><br><span class="line">select shop,</span><br><span class="line">       count(user_id) as uv</span><br><span class="line">from</span><br><span class="line">(select shop,</span><br><span class="line">        user_id</span><br><span class="line">from test_sql.test2 group by shop, user_id) as t</span><br><span class="line">group by shop ;</span><br><span class="line"></span><br><span class="line">select * from</span><br><span class="line">(select *,</span><br><span class="line">       row_number() over (partition by shop order by cnt desc) as rn</span><br><span class="line">from</span><br><span class="line">(select shop,user_id,count(1) as cnt from test_sql.test2 group by  shop,user_id ) as t) t2</span><br><span class="line">where t2.rn&lt;=3;</span><br><span class="line"></span><br><span class="line">-- 第3题：订单量统计</span><br><span class="line">CREATE TABLE test_sql.test3 (</span><br><span class="line">			dt string,</span><br><span class="line">			order_id string,</span><br><span class="line">			user_id string,</span><br><span class="line">			amount DECIMAL ( 10, 2 ) )</span><br><span class="line">ROW format delimited FIELDS TERMINATED BY &#x27;\t&#x27;;</span><br><span class="line"></span><br><span class="line">INSERT overwrite TABLE test_sql.test3 VALUES</span><br><span class="line"> (&#x27;2017-01-01&#x27;,&#x27;10029028&#x27;,&#x27;1000003251&#x27;,33.57),</span><br><span class="line"> (&#x27;2017-01-01&#x27;,&#x27;10029029&#x27;,&#x27;1000003251&#x27;,33.57),</span><br><span class="line"> (&#x27;2017-01-01&#x27;,&#x27;100290288&#x27;,&#x27;1000003252&#x27;,33.57),</span><br><span class="line"> (&#x27;2017-02-02&#x27;,&#x27;10029088&#x27;,&#x27;1000003251&#x27;,33.57),</span><br><span class="line"> (&#x27;2017-02-02&#x27;,&#x27;100290281&#x27;,&#x27;1000003251&#x27;,33.57),</span><br><span class="line"> (&#x27;2017-02-02&#x27;,&#x27;100290282&#x27;,&#x27;1000003253&#x27;,33.57),</span><br><span class="line"> (&#x27;2017-11-02&#x27;,&#x27;10290282&#x27;,&#x27;100003253&#x27;,234),</span><br><span class="line"> (&#x27;2018-11-02&#x27;,&#x27;10290284&#x27;,&#x27;100003243&#x27;,234);</span><br><span class="line"></span><br><span class="line">-- 	(1)给出 2017年每个月的订单数、用户数、总成交金额。</span><br><span class="line">-- 	(2)给出2017年11月的新客数(指在11月才有第一笔订单)</span><br><span class="line">select date_format(dt,&#x27;yyyy-MM&#x27;) as month1,</span><br><span class="line">       count(distinct order_id) as cnt1,</span><br><span class="line">       count(distinct user_id) as cnt2,</span><br><span class="line">       sum(amount) as amt</span><br><span class="line">  from test_sql.test3</span><br><span class="line">  where year(dt)=2017</span><br><span class="line">group by date_format(dt,&#x27;yyyy-MM&#x27;);</span><br><span class="line"></span><br><span class="line">select count(user_id) cnt from</span><br><span class="line">(select user_id,</span><br><span class="line">       min(date_format(dt,&#x27;yyyy-MM&#x27;)) min_month</span><br><span class="line">from test3 group by user_id) as t where min_month=&#x27;2017-11&#x27;;</span><br><span class="line"></span><br><span class="line">--统计每个月的新客户数</span><br><span class="line">select min_month,</span><br><span class="line">       count(user_id) cnt</span><br><span class="line">from (select user_id,</span><br><span class="line">             min(date_format(dt, &#x27;yyyy-MM&#x27;)) min_month</span><br><span class="line">      from test3</span><br><span class="line">      group by user_id) as t</span><br><span class="line">group by min_month;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- 第4题：大数据排序统计</span><br><span class="line">CREATE TABLE test_sql.test4user</span><br><span class="line">	(user_id string,name string,age int);</span><br><span class="line"></span><br><span class="line">CREATE TABLE test_sql.test4log</span><br><span class="line">	(user_id string,url string);</span><br><span class="line"></span><br><span class="line">INSERT INTO TABLE test_sql.test4user VALUES(&#x27;001&#x27;,&#x27;u1&#x27;,10),</span><br><span class="line">(&#x27;002&#x27;,&#x27;u2&#x27;,15),</span><br><span class="line">(&#x27;003&#x27;,&#x27;u3&#x27;,15),</span><br><span class="line">(&#x27;004&#x27;,&#x27;u4&#x27;,20),</span><br><span class="line">(&#x27;005&#x27;,&#x27;u5&#x27;,25),</span><br><span class="line">(&#x27;006&#x27;,&#x27;u6&#x27;,35),</span><br><span class="line">(&#x27;007&#x27;,&#x27;u7&#x27;,40),</span><br><span class="line">(&#x27;008&#x27;,&#x27;u8&#x27;,45),</span><br><span class="line">(&#x27;009&#x27;,&#x27;u9&#x27;,50),</span><br><span class="line">(&#x27;0010&#x27;,&#x27;u10&#x27;,65);</span><br><span class="line">INSERT INTO TABLE test_sql.test4log VALUES(&#x27;001&#x27;,&#x27;url1&#x27;),</span><br><span class="line">(&#x27;002&#x27;,&#x27;url1&#x27;),</span><br><span class="line">(&#x27;003&#x27;,&#x27;url2&#x27;),</span><br><span class="line">(&#x27;004&#x27;,&#x27;url3&#x27;),</span><br><span class="line">(&#x27;005&#x27;,&#x27;url3&#x27;),</span><br><span class="line">(&#x27;006&#x27;,&#x27;url1&#x27;),</span><br><span class="line">(&#x27;007&#x27;,&#x27;url5&#x27;),</span><br><span class="line">(&#x27;008&#x27;,&#x27;url7&#x27;),</span><br><span class="line">(&#x27;009&#x27;,&#x27;url5&#x27;),</span><br><span class="line">(&#x27;0010&#x27;,&#x27;url1&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from test_sql.test4user ;</span><br><span class="line">select * from test_sql.test4log ;</span><br><span class="line"></span><br><span class="line">--有一个5000万的用户文件(user_id，name，age)，</span><br><span class="line">-- 一个2亿记录的用户看电影的记录文件(user_id，url)，根据年龄段观看电影的次数进行排序？</span><br><span class="line">--取整函数有 round，floor，ceil</span><br><span class="line">select *,</span><br><span class="line">       round(x,0) as r,--四舍五入</span><br><span class="line">       floor(x) as f,--向下取整</span><br><span class="line">       ceil(x) as c--向上取整</span><br><span class="line">  from</span><br><span class="line">(select 15/10 as x union all</span><br><span class="line">select 18/10 as x union all</span><br><span class="line">select 24/10 as x union all</span><br><span class="line">select 27/10 as x ) as t;</span><br><span class="line"></span><br><span class="line">select type,</span><br><span class="line">       sum(cnt) as sum1</span><br><span class="line">from</span><br><span class="line">(select *,</span><br><span class="line">       concat(floor(age/10)*10,&#x27;-&#x27;,floor(age/10)*10+10) as type</span><br><span class="line">from test_sql.test4user as a</span><br><span class="line">-- join前最好提前减小数据量</span><br><span class="line">join (select user_id,count(url) as cnt from test_sql.test4log group by user_id) as b</span><br><span class="line">on a.user_id=b.user_id) as t</span><br><span class="line">group by type</span><br><span class="line">order by sum(cnt) desc;</span><br><span class="line"></span><br><span class="line">-- 第5题：活跃用户统计</span><br><span class="line">CREATE TABLE test5(</span><br><span class="line">dt string,</span><br><span class="line">user_id string,</span><br><span class="line">age int)</span><br><span class="line">ROW format delimited fields terminated BY &#x27;,&#x27;;</span><br><span class="line">INSERT overwrite TABLE test_sql.test5 VALUES (&#x27;2019-02-11&#x27;,&#x27;test_1&#x27;,23),</span><br><span class="line">(&#x27;2019-02-11&#x27;,&#x27;test_2&#x27;,19),</span><br><span class="line">(&#x27;2019-02-11&#x27;,&#x27;test_3&#x27;,39),</span><br><span class="line">(&#x27;2019-02-11&#x27;,&#x27;test_1&#x27;,23),</span><br><span class="line">(&#x27;2019-02-11&#x27;,&#x27;test_3&#x27;,39),</span><br><span class="line">(&#x27;2019-02-11&#x27;,&#x27;test_1&#x27;,23),</span><br><span class="line">(&#x27;2019-02-12&#x27;,&#x27;test_2&#x27;,19),</span><br><span class="line">(&#x27;2019-02-13&#x27;,&#x27;test_1&#x27;,23),</span><br><span class="line">(&#x27;2019-02-15&#x27;,&#x27;test_2&#x27;,19),</span><br><span class="line">(&#x27;2019-02-16&#x27;,&#x27;test_2&#x27;,19);</span><br><span class="line">select * from test_sql.test5 order by dt,user_id;</span><br><span class="line">--有日志如下，请写出代码求得所有用户和活跃用户的总数及平均年龄。（活跃用户指连续两天都有访问记录的用户）</span><br><span class="line">-- type     总数   平均年龄</span><br><span class="line">-- &#x27;所有用户&#x27;  3    27</span><br><span class="line">-- &#x27;活跃用户&#x27;  1    19</span><br><span class="line">with t1 as (select distinct dt, user_id,age from test_sql.test5),</span><br><span class="line">     t2 as (select *,row_number() over (partition by user_id order by dt) as rn from t1 ),</span><br><span class="line">     t3 as (select *,date_sub(dt,rn) as dt2 from t2),</span><br><span class="line">     t4 as (select dt2,user_id,age,count(1) cnt from t3 group by dt2,user_id,age),</span><br><span class="line">     t5 as (select * from t4 where cnt&gt;=2),</span><br><span class="line">     t6 as (select distinct user_id,age from t5)</span><br><span class="line">select &#x27;所有用户&#x27; as type, count(user_id) cnt,avg(age) as avg_age</span><br><span class="line">from (select distinct user_id,age from test_sql.test5) t union all</span><br><span class="line">select &#x27;活跃用户&#x27; as type, count(user_id) cnt,avg(age) as avg_age from t6;</span><br><span class="line"></span><br><span class="line">-- 用思路2来分析连续2天登录</span><br><span class="line">with t1 as (select distinct dt, user_id from test_sql.test5),</span><br><span class="line">     t2 as (select *,</span><br><span class="line">                   date_add(dt,1) as dt2,</span><br><span class="line">                   lead(dt,1)over(partition by user_id order by dt) as dt3</span><br><span class="line">              from t1)</span><br><span class="line">select count(distinct user_id) from t2 where dt2=dt3;</span><br><span class="line"></span><br><span class="line">-- 第6题：电商购买金额统计实战</span><br><span class="line">CREATE TABLE test_sql.test6 (</span><br><span class="line">		userid string,</span><br><span class="line">		money decimal(10,2),</span><br><span class="line">		paymenttime string,</span><br><span class="line">		orderid string);</span><br><span class="line"></span><br><span class="line">INSERT INTO TABLE test_sql.test6 VALUES(&#x27;001&#x27;,100,&#x27;2017-10-01&#x27;,&#x27;123&#x27;),</span><br><span class="line">(&#x27;001&#x27;,200,&#x27;2017-10-02&#x27;,&#x27;124&#x27;),</span><br><span class="line">(&#x27;002&#x27;,500,&#x27;2017-10-01&#x27;,&#x27;125&#x27;),</span><br><span class="line">(&#x27;001&#x27;,100,&#x27;2017-11-01&#x27;,&#x27;126&#x27;);</span><br><span class="line"></span><br><span class="line">select * from test_sql.test6 order by userid,paymenttime;</span><br><span class="line">--请用sql写出所有用户中在今年10月份第一次购买商品的金额，</span><br><span class="line">select userid,paymenttime,money</span><br><span class="line">from</span><br><span class="line">(select *,</span><br><span class="line">       row_number() over (partition by userid order by paymenttime) as rn</span><br><span class="line">       from test_sql.test6 where date_format(paymenttime,&#x27;yyyy-MM&#x27;)=&#x27;2017-10&#x27; ) as t</span><br><span class="line">where t.rn=1</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- 第7题：教育领域SQL实战</span><br><span class="line">CREATE TABLE test_sql.book(book_id string,</span><br><span class="line">		`SORT` string,</span><br><span class="line">		book_name string,</span><br><span class="line">		 writer string,</span><br><span class="line">		 OUTPUT string,</span><br><span class="line">		 price decimal(10,2));</span><br><span class="line">INSERT INTO TABLE test_sql.book VALUES</span><br><span class="line">(&#x27;001&#x27;,&#x27;TP391&#x27;,&#x27;信息处理&#x27;,&#x27;author1&#x27;,&#x27;机械工业出版社&#x27;,&#x27;20&#x27;),</span><br><span class="line">(&#x27;002&#x27;,&#x27;TP392&#x27;,&#x27;数据库&#x27;,&#x27;author12&#x27;,&#x27;科学出版社&#x27;,&#x27;15&#x27;),</span><br><span class="line">(&#x27;003&#x27;,&#x27;TP393&#x27;,&#x27;计算机网络&#x27;,&#x27;author3&#x27;,&#x27;机械工业出版社&#x27;,&#x27;29&#x27;),</span><br><span class="line">(&#x27;004&#x27;,&#x27;TP399&#x27;,&#x27;微机原理&#x27;,&#x27;author4&#x27;,&#x27;科学出版社&#x27;,&#x27;39&#x27;),</span><br><span class="line">(&#x27;005&#x27;,&#x27;C931&#x27;,&#x27;管理信息系统&#x27;,&#x27;author5&#x27;,&#x27;机械工业出版社&#x27;,&#x27;40&#x27;),</span><br><span class="line">(&#x27;006&#x27;,&#x27;C932&#x27;,&#x27;运筹学&#x27;,&#x27;author6&#x27;,&#x27;科学出版社&#x27;,&#x27;55&#x27;);</span><br><span class="line"></span><br><span class="line">CREATE TABLE test_sql.reader (reader_id string,</span><br><span class="line">				company string,</span><br><span class="line">				name string,</span><br><span class="line">				sex string,</span><br><span class="line">				grade string,</span><br><span class="line">				addr string);</span><br><span class="line">INSERT INTO TABLE test_sql.reader VALUES</span><br><span class="line">(&#x27;0001&#x27;,&#x27;阿里巴巴&#x27;,&#x27;jack&#x27;,&#x27;男&#x27;,&#x27;vp&#x27;,&#x27;addr1&#x27;),</span><br><span class="line">(&#x27;0002&#x27;,&#x27;百度&#x27;,&#x27;robin&#x27;,&#x27;男&#x27;,&#x27;vp&#x27;,&#x27;addr2&#x27;),</span><br><span class="line">(&#x27;0003&#x27;,&#x27;腾讯&#x27;,&#x27;tony&#x27;,&#x27;男&#x27;,&#x27;vp&#x27;,&#x27;addr3&#x27;),</span><br><span class="line">(&#x27;0004&#x27;,&#x27;京东&#x27;,&#x27;jasper&#x27;,&#x27;男&#x27;,&#x27;cfo&#x27;,&#x27;addr4&#x27;),</span><br><span class="line">(&#x27;0005&#x27;,&#x27;网易&#x27;,&#x27;zhangsan&#x27;,&#x27;女&#x27;,&#x27;ceo&#x27;,&#x27;addr5&#x27;),</span><br><span class="line">(&#x27;0006&#x27;,&#x27;搜狐&#x27;,&#x27;lisi&#x27;,&#x27;女&#x27;,&#x27;ceo&#x27;,&#x27;addr6&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE test_sql.borrow_log(reader_id string,</span><br><span class="line">				book_id string,</span><br><span class="line">				borrow_date string);</span><br><span class="line"></span><br><span class="line">INSERT INTO TABLE test_sql.borrow_log VALUES (&#x27;0001&#x27;,&#x27;002&#x27;,&#x27;2019-10-14&#x27;),</span><br><span class="line">(&#x27;0002&#x27;,&#x27;001&#x27;,&#x27;2019-10-13&#x27;),</span><br><span class="line">(&#x27;0003&#x27;,&#x27;005&#x27;,&#x27;2019-09-14&#x27;),</span><br><span class="line">(&#x27;0004&#x27;,&#x27;006&#x27;,&#x27;2019-08-15&#x27;),</span><br><span class="line">(&#x27;0005&#x27;,&#x27;003&#x27;,&#x27;2019-10-10&#x27;),</span><br><span class="line">(&#x27;0006&#x27;,&#x27;004&#x27;,&#x27;2019-17-13&#x27;);</span><br><span class="line"></span><br><span class="line">select * from test_sql.book;</span><br><span class="line">select * from test_sql.reader;</span><br><span class="line">select * from test_sql.borrow_log;</span><br><span class="line"></span><br><span class="line">--（8）考虑到数据安全的需要，需定时将“借阅记录”中数据进行备份，请使用一条SQL语句，</span><br><span class="line">-- 在备份用户bak下创建与“借阅记录”表结构完全一致的数据表BORROW_LOG_BAK.</span><br><span class="line">-- 井且将“借阅记录”中现有数据全部复制到BORROW_L0G_ BAK中。</span><br><span class="line">create table test_sql.BORROW_LOG_BAK as select * from test_sql.borrow_log;</span><br><span class="line">select * from test_sql.BORROW_LOG_BAK;</span><br><span class="line"></span><br><span class="line">--（9）现在需要将原Oracle数据库中数据迁移至Hive仓库，</span><br><span class="line">-- 请写出“图书”在Hive中的建表语句（Hive实现，提示：列分隔符|；</span><br><span class="line">-- 数据表数据需要外部导入：分区分别以month＿part、day＿part 命名）</span><br><span class="line">CREATE TABLE test_sql.book2</span><br><span class="line">(</span><br><span class="line">    book_id   string,</span><br><span class="line">    `SORT`    string,</span><br><span class="line">    book_name string,</span><br><span class="line">    writer    string,</span><br><span class="line">    OUTPUT    string,</span><br><span class="line">    price     decimal(10, 2)</span><br><span class="line">)partitioned by (month_part string,day_part string )</span><br><span class="line">    row format delimited fields terminated by &#x27;|&#x27;;</span><br><span class="line"></span><br><span class="line">--（10）Hive中有表A，现在需要将表A的月分区　201505　中　</span><br><span class="line">-- user＿id为20000的user＿dinner字段更新为bonc8920，其他用户user＿dinner字段数据不变，</span><br><span class="line">-- 请列出更新的方法步骤。（Hive实现，提示：Hive中无update语法，请通过其他办法进行数据更新）</span><br><span class="line">--A</span><br><span class="line">-- user_id   user_dinner  part</span><br><span class="line">-- 20000        aaaaa     201505</span><br><span class="line">-- 30000        bbbbb     201505</span><br><span class="line"></span><br><span class="line">create table A (user_id int,user_dinner string) partitioned by (part string);</span><br><span class="line">insert overwrite table A partition (part = &#x27;201505&#x27;)</span><br><span class="line">values (20000, &#x27;aaaaa&#x27;),</span><br><span class="line">       (30000, &#x27;bbbbb&#x27;),</span><br><span class="line">       (40000, &#x27;ccccc&#x27;);</span><br><span class="line">select * from A;</span><br><span class="line">--update A set user_dinner=&#x27;bonc8920&#x27; where user_id=20000;</span><br><span class="line"></span><br><span class="line">insert overwrite table A partition  (part = &#x27;201505&#x27;)</span><br><span class="line">select user_id, &#x27;bonc8920&#x27; as user_dinner from A where user_id=20000 and part = &#x27;201505&#x27; union all</span><br><span class="line">select user_id, user_dinner from A where user_id!=20000 and part = &#x27;201505&#x27;  ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- 第8题：服务日志SQL统计</span><br><span class="line">CREATE TABLE test_sql.test8(`date` string,</span><br><span class="line">				interface string,</span><br><span class="line">				ip string);</span><br><span class="line"></span><br><span class="line">INSERT INTO TABLE test_sql.test8 VALUES</span><br><span class="line">(&#x27;2016-11-09 11:22:05&#x27;,&#x27;/api/user/login&#x27;,&#x27;110.23.5.23&#x27;),</span><br><span class="line">(&#x27;2016-11-09 11:23:10&#x27;,&#x27;/api/user/detail&#x27;,&#x27;57.3.2.16&#x27;),</span><br><span class="line">(&#x27;2016-11-09 23:59:40&#x27;,&#x27;/api/user/login&#x27;,&#x27;200.6.5.166&#x27;),</span><br><span class="line">(&#x27;2016-11-09 11:14:23&#x27;,&#x27;/api/user/login&#x27;,&#x27;136.79.47.70&#x27;),</span><br><span class="line">(&#x27;2016-11-09 11:15:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;94.144.143.141&#x27;),</span><br><span class="line">(&#x27;2016-11-09 11:16:23&#x27;,&#x27;/api/user/login&#x27;,&#x27;197.161.8.206&#x27;),</span><br><span class="line">(&#x27;2016-11-09 12:14:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;240.227.107.145&#x27;),</span><br><span class="line">(&#x27;2016-11-09 13:14:23&#x27;,&#x27;/api/user/login&#x27;,&#x27;79.130.122.205&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:14:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;65.228.251.189&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:15:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;245.23.122.44&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:17:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;22.74.142.137&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:19:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;54.93.212.87&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:20:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;218.15.167.248&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:24:23&#x27;,&#x27;/api/user/detail&#x27;,&#x27;20.117.19.75&#x27;),</span><br><span class="line">(&#x27;2016-11-09 15:14:23&#x27;,&#x27;/api/user/login&#x27;,&#x27;183.162.66.97&#x27;),</span><br><span class="line">(&#x27;2016-11-09 16:14:23&#x27;,&#x27;/api/user/login&#x27;,&#x27;108.181.245.147&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:17:23&#x27;,&#x27;/api/user/login&#x27;,&#x27;22.74.142.137&#x27;),</span><br><span class="line">(&#x27;2016-11-09 14:19:23&#x27;,&#x27;/api/user/login&#x27;,&#x27;22.74.142.137&#x27;);</span><br><span class="line"></span><br><span class="line">select * from test_sql.test8;</span><br><span class="line">--求11月9号下午14点（14-15点），访问/api/user/login接口的top10的ip地址</span><br><span class="line">select ip, count(1) cnt</span><br><span class="line">from test_sql.test8</span><br><span class="line">where date_format(`date`, &#x27;yyyy-MM-dd HH&#x27;) = &#x27;2016-11-09 14&#x27;</span><br><span class="line">  and interface = &#x27;/api/user/login&#x27;</span><br><span class="line">group by ip</span><br><span class="line">order by cnt desc</span><br><span class="line">limit 10</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">-- 第9题：充值日志SQL实战</span><br><span class="line">CREATE TABLE test_sql.test9(</span><br><span class="line">			dist_id string COMMENT &#x27;区组id&#x27;,</span><br><span class="line">			account string COMMENT &#x27;账号&#x27;,</span><br><span class="line">		   `money` decimal(10,2) COMMENT &#x27;充值金额&#x27;,</span><br><span class="line">			create_time string COMMENT &#x27;订单时间&#x27;);</span><br><span class="line"></span><br><span class="line">INSERT INTO TABLE test_sql.test9 VALUES (&#x27;1&#x27;,&#x27;11&#x27;,100006,&#x27;2019-01-02 13:00:01&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;22&#x27;,110000,&#x27;2019-01-02 13:00:02&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;33&#x27;,102000,&#x27;2019-01-02 13:00:03&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;44&#x27;,100300,&#x27;2019-01-02 13:00:04&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;55&#x27;,100040,&#x27;2019-01-02 13:00:05&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;66&#x27;,100005,&#x27;2019-01-02 13:00:06&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;77&#x27;,180000,&#x27;2019-01-03 13:00:07&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;88&#x27;,106000,&#x27;2019-01-02 13:00:08&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;99&#x27;,100400,&#x27;2019-01-02 13:00:09&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;12&#x27;,100030,&#x27;2019-01-02 13:00:10&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;13&#x27;,100003,&#x27;2019-01-02 13:00:20&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;14&#x27;,100020,&#x27;2019-01-02 13:00:30&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;15&#x27;,100500,&#x27;2019-01-02 13:00:40&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;16&#x27;,106000,&#x27;2019-01-02 13:00:50&#x27;),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;17&#x27;,100800,&#x27;2019-01-02 13:00:59&#x27;),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;18&#x27;,100800,&#x27;2019-01-02 13:00:11&#x27;),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;19&#x27;,100030,&#x27;2019-01-02 13:00:12&#x27;),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;10&#x27;,100000,&#x27;2019-01-02 13:00:13&#x27;),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;45&#x27;,100010,&#x27;2019-01-02 13:00:14&#x27;),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;78&#x27;,100070,&#x27;2019-01-02 13:00:15&#x27;);</span><br><span class="line"></span><br><span class="line">select * from test_sql.test9 order by dist_id , money desc;</span><br><span class="line">--请写出SQL语句，查询充值日志表2019年01月02号每个区组下充值额最大的账号，要求结果：</span><br><span class="line">--区组id，账号，金额，充值时间</span><br><span class="line">select * from</span><br><span class="line">(select *,</span><br><span class="line">       row_number() over (partition by dist_id order by money desc) rn</span><br><span class="line">from  test_sql.test9 where to_date(create_time)=&#x27;2019-01-02&#x27;) t</span><br><span class="line">where t.rn=1;</span><br><span class="line"></span><br><span class="line">-- 第10题：电商分组TopK实战</span><br><span class="line">CREATE TABLE test_sql.test10(</span><br><span class="line">	`dist_id` string COMMENT &#x27;区组id&#x27;,</span><br><span class="line">	`account` string COMMENT &#x27;账号&#x27;,</span><br><span class="line">	`gold` int COMMENT &#x27;金币&#x27;);</span><br><span class="line"></span><br><span class="line">INSERT INTO TABLE test_sql.test10 VALUES (&#x27;1&#x27;,&#x27;77&#x27;,18),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;88&#x27;,106),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;99&#x27;,10),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;12&#x27;,13),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;13&#x27;,14),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;14&#x27;,25),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;15&#x27;,36),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;16&#x27;,12),</span><br><span class="line"> (&#x27;1&#x27;,&#x27;17&#x27;,158),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;18&#x27;,12),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;19&#x27;,44),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;10&#x27;,66),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;45&#x27;,80),</span><br><span class="line"> (&#x27;2&#x27;,&#x27;78&#x27;,98);</span><br><span class="line"></span><br><span class="line">select * from test_sql.test10;</span><br><span class="line"></span><br><span class="line">select * from</span><br><span class="line">(select *,</span><br><span class="line">       row_number() over (partition by dist_id order by gold desc) rn</span><br><span class="line">from  test_sql.test10  ) t</span><br><span class="line">where t.rn&lt;=10;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="行转列-转置"><a href="#行转列-转置" class="headerlink" title="行转列(转置)"></a>行转列(转置)</h2><ul>
<li>行转列的常规做法是，group by+sum(if())【或count(if())】</li>
</ul>
<h3 id="华泰证券1"><a href="#华泰证券1" class="headerlink" title="华泰证券1"></a>华泰证券1</h3><p>已知</p>
<table>
<thead>
<tr>
<th>year</th>
<th>month</th>
<th>amount</th>
</tr>
</thead>
<tbody><tr>
<td>1991</td>
<td>1</td>
<td>1.1</td>
</tr>
<tr>
<td>1991</td>
<td>2</td>
<td>1.2</td>
</tr>
<tr>
<td>1991</td>
<td>3</td>
<td>1.3</td>
</tr>
<tr>
<td>1991</td>
<td>4</td>
<td>1.4</td>
</tr>
<tr>
<td>1992</td>
<td>1</td>
<td>2.1</td>
</tr>
<tr>
<td>1992</td>
<td>2</td>
<td>2.2</td>
</tr>
<tr>
<td>1992</td>
<td>3</td>
<td>2.3</td>
</tr>
<tr>
<td>1992</td>
<td>4</td>
<td>2.4</td>
</tr>
</tbody></table>
<p>查成这样一个结果</p>
<table>
<thead>
<tr>
<th>year</th>
<th>m1</th>
<th>m2</th>
<th>m3</th>
<th>m4</th>
</tr>
</thead>
<tbody><tr>
<td>1991</td>
<td>1.1</td>
<td>1.2</td>
<td>1.3</td>
<td>1.4</td>
</tr>
<tr>
<td>1992</td>
<td>2.1</td>
<td>2.2</td>
<td>2.3</td>
<td>2.4</td>
</tr>
</tbody></table>
<p>解答</p>
<ul>
<li><p>&#96;&#96;&#96;sql<br>use test_sql;<br>set hive.exec.mode.local.auto&#x3D;true;<br>create table table2(year int,month int ,amount double) ;<br> insert overwrite table table2 values<br>       (1991,1,1.1),<br>       (1991,2,1.2),<br>       (1991,3,1.3),<br>       (1991,4,1.4),<br>       (1992,1,2.1),<br>       (1992,2,2.2),<br>       (1992,3,2.3),<br>       (1992,4,2.4);<br>select * from table2;</p>
<p>–行转列<br>–常规做法是，group by+sum(if())<br>–原始写法<br>select year,<br>   sum(a) as m1,<br>   sum(b) as m2,<br>   sum(c) as m3,<br>   sum(d) as m4<br>from<br>(select *,<br>        if(month&#x3D;1,amount,0) a,<br>        if(month&#x3D;2,amount,0) b,<br>        if(month&#x3D;3,amount,0) c,<br>        if(month&#x3D;4,amount,0) d<br> from table2) t<br>group by t.year<br>;<br>–简化写法<br>select year,<br>   sum(if(month&#x3D;1,amount,0)) m1,<br>   sum(if(month&#x3D;2,amount,0)) m2,<br>   sum(if(month&#x3D;3,amount,0)) m3,<br>   sum(if(month&#x3D;4,amount,0)) m4<br>from table2<br>group by year;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 华泰证券2</span><br><span class="line"></span><br><span class="line">* 查询课程编号“2”的成绩比课程编号“1”低的所有同学的学号、姓名。</span><br><span class="line"></span><br><span class="line">* 【这是行转列的衍生题】</span><br><span class="line"></span><br><span class="line">* ```sql</span><br><span class="line">  create table student(sid int, sname string, gender string, class_id int);</span><br><span class="line">  insert overwrite table student</span><br><span class="line">  values (1, &#x27;张三&#x27;, &#x27;女&#x27;, 1),</span><br><span class="line">         (2, &#x27;李四&#x27;, &#x27;女&#x27;, 1),</span><br><span class="line">         (3, &#x27;王五&#x27;, &#x27;男&#x27;, 2);</span><br><span class="line">  </span><br><span class="line">  select * from student;</span><br><span class="line">  </span><br><span class="line">  create table  course (cid int, cname string, teacher_id int);</span><br><span class="line">  insert overwrite table course</span><br><span class="line">  values (1, &#x27;生物&#x27;, 1),</span><br><span class="line">         (2, &#x27;体育&#x27;, 1),</span><br><span class="line">         (3, &#x27;物理&#x27;, 2);</span><br><span class="line">  select * from course;</span><br><span class="line">  </span><br><span class="line">  create table score (sid int, student_id int, course_id int, number int);</span><br><span class="line">  insert overwrite table score</span><br><span class="line">  values (1, 1, 1, 58),</span><br><span class="line">         (4, 1, 2, 50),</span><br><span class="line">         (2, 1, 2, 68),</span><br><span class="line">         (3, 2, 2, 89);</span><br><span class="line">  select * from score;</span><br><span class="line">  </span><br><span class="line">  with t1 as(</span><br><span class="line">      select student_id,</span><br><span class="line">         sum(if(course_id=2,number,0)) as pe, --体育</span><br><span class="line">         sum(if(course_id=1,number,0)) as bio --生物</span><br><span class="line">  from score</span><br><span class="line">  group by student_id</span><br><span class="line">  having pe&lt;bio)</span><br><span class="line">  select sid, sname</span><br><span class="line">  from t1</span><br><span class="line">  join student</span><br><span class="line">  on t1.student_id = sid</span><br><span class="line">  ;</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="腾讯游戏"><a href="#腾讯游戏" class="headerlink" title="腾讯游戏"></a>腾讯游戏</h3><p>表table如下：</p>
<table>
<thead>
<tr>
<th>DDate</th>
<th>shengfu</th>
</tr>
</thead>
<tbody><tr>
<td>2015-05-09</td>
<td>胜</td>
</tr>
<tr>
<td>2015-05-09</td>
<td>胜</td>
</tr>
<tr>
<td>2015-05-09</td>
<td>负</td>
</tr>
<tr>
<td>2015-05-09</td>
<td>负</td>
</tr>
<tr>
<td>2015-05-10</td>
<td>胜</td>
</tr>
<tr>
<td>2015-05-10</td>
<td>负</td>
</tr>
<tr>
<td>2015-05-10</td>
<td>负</td>
</tr>
</tbody></table>
<p>如果要生成下列结果, 该如何写sql语句?</p>
<table>
<thead>
<tr>
<th>DDate</th>
<th>胜</th>
<th>负</th>
</tr>
</thead>
<tbody><tr>
<td>2015-05-09</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>2015-05-10</td>
<td>1</td>
<td>2</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table1(DDate string, shengfu string) ;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> table1 <span class="keyword">values</span> (<span class="string">&#x27;2015-05-09&#x27;</span>, &quot;胜&quot;),</span><br><span class="line">       (<span class="string">&#x27;2015-05-09&#x27;</span>, &quot;胜&quot;),</span><br><span class="line">       (<span class="string">&#x27;2015-05-09&#x27;</span>, &quot;负&quot;),</span><br><span class="line">       (<span class="string">&#x27;2015-05-09&#x27;</span>, &quot;负&quot;),</span><br><span class="line">       (<span class="string">&#x27;2015-05-10&#x27;</span>, &quot;胜&quot;),</span><br><span class="line">       (<span class="string">&#x27;2015-05-10&#x27;</span>, &quot;负&quot;),</span><br><span class="line">       (<span class="string">&#x27;2015-05-10&#x27;</span>, &quot;负&quot;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> DDate,</span><br><span class="line">       <span class="built_in">SUM</span>(<span class="keyword">case</span> <span class="keyword">when</span> shengfu <span class="operator">=</span> <span class="string">&#x27;胜&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) `胜`,</span><br><span class="line">       <span class="built_in">SUM</span>(<span class="keyword">case</span> <span class="keyword">when</span> shengfu <span class="operator">=</span> <span class="string">&#x27;负&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) `负`</span><br><span class="line"><span class="keyword">from</span> table1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> DDate;</span><br></pre></td></tr></table></figure>

<h3 id="腾讯QQ"><a href="#腾讯QQ" class="headerlink" title="腾讯QQ"></a>腾讯QQ</h3><p>假设tableA如表5, tableB如表6,</p>
<p>表5	</p>
<table>
<thead>
<tr>
<th>qq号（字段名：qq）</th>
<th>游戏（字段名：game）</th>
</tr>
</thead>
<tbody><tr>
<td>10000</td>
<td>a</td>
</tr>
<tr>
<td>10000</td>
<td>b</td>
</tr>
<tr>
<td>10000</td>
<td>c</td>
</tr>
<tr>
<td>20000</td>
<td>c</td>
</tr>
<tr>
<td>20000</td>
<td>d</td>
</tr>
</tbody></table>
<p>表6</p>
<table>
<thead>
<tr>
<th>qq号（字段名：qq）</th>
<th>游戏（字段名：game）</th>
</tr>
</thead>
<tbody><tr>
<td>10000</td>
<td>a_b_c</td>
</tr>
<tr>
<td>20000</td>
<td>c_d</td>
</tr>
</tbody></table>
<p> 请写出以下sql逻辑：</p>
<p>a,	将tableA输出为tableB的格式； 【行转列】</p>
<p>b,	将tableB输出为tableA的格式;   【列转行】</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tableA(qq string, game string) </span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> tableA <span class="keyword">values</span> </span><br><span class="line">       (<span class="number">10000</span>, <span class="string">&#x27;a&#x27;</span>),</span><br><span class="line">       (<span class="number">10000</span>, <span class="string">&#x27;b&#x27;</span>),</span><br><span class="line">       (<span class="number">10000</span>, <span class="string">&#x27;c&#x27;</span>),</span><br><span class="line">       (<span class="number">20000</span>, <span class="string">&#x27;c&#x27;</span>),</span><br><span class="line">       (<span class="number">20000</span>, <span class="string">&#x27;d&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tableB(qq string, game string) ;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> tableB <span class="keyword">values</span> </span><br><span class="line">(<span class="number">10000</span>, <span class="string">&#x27;a_b_c&#x27;</span>),</span><br><span class="line">(<span class="number">20000</span>, <span class="string">&#x27;c_d&#x27;</span>);</span><br><span class="line">       </span><br><span class="line"><span class="comment">--将tableA输出为tableB的格式；  </span></span><br><span class="line"><span class="keyword">select</span> qq,</span><br><span class="line">       concat_ws(<span class="string">&#x27;_&#x27;</span>, collect_list(game)) game</span><br><span class="line"><span class="keyword">from</span> tableA</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> qq;   </span><br><span class="line">       </span><br><span class="line"><span class="comment">--将tableB输出为tableA的格式;    </span></span><br><span class="line"><span class="keyword">select</span> qq,</span><br><span class="line">       tmp.game</span><br><span class="line"><span class="keyword">from</span> tableB <span class="keyword">lateral</span> <span class="keyword">view</span> explode(split(game, <span class="string">&#x27;_&#x27;</span>)) tmp <span class="keyword">as</span> game;</span><br></pre></td></tr></table></figure>





<h2 id="连续N天登陆"><a href="#连续N天登陆" class="headerlink" title="连续N天登陆"></a>连续N天登陆</h2><ul>
<li><p>思路分析过程</p>
<ul>
<li><p><img src="E:\自研项目\sql资料\4\images\1659757393656.png" alt="1659757393656"></p>
</li>
<li><p>&#96;&#96;&#96;sql<br>–核心代码<br>-&gt;distinct<br>-&gt; row_number<br>-&gt; date_sub(dt,rn) as dt2<br>-&gt; group by dt2,name<br>-&gt; having count(1)&gt;&#x3D;N天<br>-&gt; distinct name<br>-&gt; count(name)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">* 思路2</span><br><span class="line"></span><br><span class="line">* ![1659759179547](E:\自研项目\sql资料\4\images\1659759179547.png)</span><br><span class="line"></span><br><span class="line">* ```sql</span><br><span class="line">  --核心代码</span><br><span class="line">  -&gt;distinct</span><br><span class="line">  -&gt;date_add(dt,N-1) as date2</span><br><span class="line">  -&gt;lead(dt,N-1) over(partition by userid order by dt) as date3</span><br><span class="line">  -&gt;where date2=date3</span><br><span class="line">  -&gt;distinct</span><br><span class="line">  </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="OPPO"><a href="#OPPO" class="headerlink" title="OPPO"></a>OPPO</h3><p>3、以下为用户登陆游戏的日期，用一条sQL语句查询出连续三天登录的人员姓名</p>
<table>
<thead>
<tr>
<th>name</th>
<th>date</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>2021-01-01</td>
</tr>
<tr>
<td>张三</td>
<td>2021-01-02</td>
</tr>
<tr>
<td>张三</td>
<td>2021-01-03</td>
</tr>
<tr>
<td>张三</td>
<td>2021-01-02</td>
</tr>
<tr>
<td>李四</td>
<td>2021-01-01</td>
</tr>
<tr>
<td>李四</td>
<td>2021-01-02</td>
</tr>
<tr>
<td>王五</td>
<td>2021-01-03</td>
</tr>
<tr>
<td>王五</td>
<td>2021-01-02</td>
</tr>
<tr>
<td>王五</td>
<td>2021-01-02</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> game(name string,  `<span class="type">date</span>` string);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> game <span class="keyword">values</span></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;2021-01-02&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;2021-01-03&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;2021-01-02&#x27;</span>),</span><br><span class="line"></span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;2021-01-07&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;2021-01-08&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;2021-01-09&#x27;</span>),</span><br><span class="line"></span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;李四&#x27;</span>,<span class="string">&#x27;2021-01-02&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>,<span class="string">&#x27;2021-01-03&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>,<span class="string">&#x27;2021-01-02&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;王五&#x27;</span>,<span class="string">&#x27;2021-01-02&#x27;</span>);</span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> ( <span class="keyword">select</span> <span class="keyword">distinct</span>  name,<span class="type">date</span> <span class="keyword">from</span> game),</span><br><span class="line">     t2 <span class="keyword">as</span> ( <span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">                    <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> <span class="type">date</span>) rn</span><br><span class="line">         <span class="keyword">from</span> t1),</span><br><span class="line">     t3 <span class="keyword">as</span> ( <span class="keyword">select</span> <span class="operator">*</span>,date_sub(<span class="type">date</span>,rn) date2 <span class="keyword">from</span> t2 )</span><br><span class="line">     <span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> t3 <span class="keyword">group</span> <span class="keyword">by</span> name,date2 <span class="keyword">having</span> <span class="built_in">count</span>(<span class="number">1</span>)<span class="operator">&gt;=</span><span class="number">3</span>;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line"><span class="comment">--方案二</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> game;</span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> name,`<span class="type">date</span>` <span class="keyword">from</span> game</span><br><span class="line">),</span><br><span class="line">    t2 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">               date_add(`<span class="type">date</span>`,<span class="number">3</span><span class="number">-1</span>) <span class="keyword">as</span> date2,</span><br><span class="line">               <span class="built_in">lead</span>(`<span class="type">date</span>`,<span class="number">3</span><span class="number">-1</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> `<span class="type">date</span>`) <span class="keyword">as</span> date3</span><br><span class="line">          <span class="keyword">from</span> t1</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> t2 <span class="keyword">where</span> date2<span class="operator">=</span>date3;</span><br><span class="line"><span class="comment">--方案二的写法2</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> name,`<span class="type">date</span>` <span class="keyword">from</span> game</span><br><span class="line">),</span><br><span class="line">    t2 <span class="keyword">as</span> (</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">               <span class="built_in">lead</span>(`<span class="type">date</span>`,<span class="number">3</span><span class="number">-1</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> `<span class="type">date</span>`) <span class="keyword">as</span> date3</span><br><span class="line">          <span class="keyword">from</span> t1</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> name <span class="keyword">from</span> t2 <span class="keyword">where</span> datediff(date3,`<span class="type">date</span>`)<span class="operator">=</span><span class="number">2</span> ;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="脉脉"><a href="#脉脉" class="headerlink" title="脉脉"></a>脉脉</h3><p>用户每日登陆脉脉会访问app不同的模块，现有两个表</p>
<p>表1记录了每日脉脉活跃用户的uid和不同模块的活跃时长</p>
<p>表2记录了脉脉所有注册用户的一些属性</p>
<p>表1：maimai.dau</p>
<table>
<thead>
<tr>
<th>d</th>
<th>uid</th>
<th>module</th>
<th>active_duration</th>
<th>列说明</th>
</tr>
</thead>
<tbody><tr>
<td>2020-01-01</td>
<td>1</td>
<td>jobs</td>
<td>324</td>
<td>d：活跃的日期uid：用户的唯一编码module：用户活跃模块actre.duration：该模块下对应的活跃时长（单位：s）</td>
</tr>
<tr>
<td>2020-01-01</td>
<td>2</td>
<td>feeds</td>
<td>445</td>
<td></td>
</tr>
<tr>
<td>2020-01-01</td>
<td>3</td>
<td>im</td>
<td>345</td>
<td></td>
</tr>
<tr>
<td>2020-01-02</td>
<td>2</td>
<td>network</td>
<td>765</td>
<td></td>
</tr>
<tr>
<td>2020-01-02</td>
<td>3</td>
<td>jobs</td>
<td>342</td>
<td></td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td></td>
</tr>
</tbody></table>
<p> 在过去一个月内,曾连续两天活跃的用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表</span></span><br><span class="line"><span class="comment">-- 表1 dau   记录了每日脉脉活跃用户的uid和不同模块的活跃时长</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dau(d string, uid <span class="type">int</span>, <span class="keyword">module</span> string, active_duration <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dau</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;2020-01-01&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;jobs&#x27;</span>, <span class="number">324</span>),</span><br><span class="line">       (<span class="string">&#x27;2020-01-01&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;feeds&#x27;</span>, <span class="number">445</span>),</span><br><span class="line">       (<span class="string">&#x27;2020-01-01&#x27;</span>, <span class="number">3</span>, <span class="string">&#x27;im&#x27;</span>, <span class="number">345</span>),</span><br><span class="line">       (<span class="string">&#x27;2020-01-02&#x27;</span>, <span class="number">2</span>, <span class="string">&#x27;network&#x27;</span>, <span class="number">765</span>),</span><br><span class="line">       (<span class="string">&#x27;2020-01-02&#x27;</span>, <span class="number">3</span>, <span class="string">&#x27;jobs&#x27;</span>, <span class="number">342</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span><span class="keyword">from</span> dau;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">DISTINCT</span> d, uid <span class="keyword">from</span> dau),</span><br><span class="line">     t2 <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">                date_sub(d, (<span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> uid <span class="keyword">order</span> <span class="keyword">by</span> d))) dis</span><br><span class="line">         <span class="keyword">from</span> t1</span><br><span class="line">         <span class="keyword">where</span> d <span class="operator">&lt;=</span> `<span class="built_in">current_date</span>`()</span><br><span class="line">           <span class="keyword">and</span> d <span class="operator">&gt;=</span> date_sub((`<span class="built_in">current_date</span>`()), <span class="number">30</span>)),</span><br><span class="line">t3 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> uid,</span><br><span class="line">           <span class="built_in">min</span>(d)   `开始日期`,</span><br><span class="line">           <span class="built_in">max</span>(d)   `结束日期`,</span><br><span class="line">           <span class="built_in">count</span>(<span class="number">1</span>) `连续登入天数`</span><br><span class="line">    <span class="keyword">from</span> t2</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> uid,dis</span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">&gt;=</span> <span class="number">2</span> </span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">DISTINCT</span> uid <span class="keyword">from</span> t3 ;</span><br></pre></td></tr></table></figure>

<h3 id="广州银行"><a href="#广州银行" class="headerlink" title="广州银行"></a>广州银行</h3><p>有一张表C_T（列举了部分数据）表示持卡人消费记录，表结构如下：</p>
<table>
<thead>
<tr>
<th>CARD NER</th>
<th>VARCHAR2</th>
<th>卡号，</th>
</tr>
</thead>
<tbody><tr>
<td>C_MONTH</td>
<td>NUMBER</td>
<td>消费月份，</td>
</tr>
<tr>
<td>C_DATE</td>
<td>DATE</td>
<td>消费日期，</td>
</tr>
<tr>
<td>C_TYPEVAR</td>
<td>CHAR2</td>
<td>消费类型</td>
</tr>
<tr>
<td>C_ATM</td>
<td>NUMBER</td>
<td>消费金额</td>
</tr>
</tbody></table>
<p> 每个月每张卡连续消费的最大天数（如卡在当月只有一次消费则为1）。</p>
<p>连续消费天数：指一楼时间内连续每天都有消费，同一天有多笔消费算一天消费，不能跨月份统计。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> c_t</span><br><span class="line">(</span><br><span class="line">    card_nbr string,</span><br><span class="line">    c_month  string,</span><br><span class="line">    c_date   string,</span><br><span class="line">    c_type   string,</span><br><span class="line">    c_atm    <span class="type">decimal</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> c_t <span class="keyword">values</span></span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-01&#x27;</span>,<span class="string">&#x27;2022-01-01&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">100</span>),</span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-01&#x27;</span>,<span class="string">&#x27;2022-01-02&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">200</span>),</span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-01&#x27;</span>,<span class="string">&#x27;2022-01-03&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">300</span>),</span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-01&#x27;</span>,<span class="string">&#x27;2022-01-15&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">100</span>),</span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-01&#x27;</span>,<span class="string">&#x27;2022-01-16&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">200</span>),</span><br><span class="line">                               (<span class="number">2</span>,<span class="string">&#x27;2022-01&#x27;</span>,<span class="string">&#x27;2022-01-06&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">500</span>),</span><br><span class="line">                               (<span class="number">2</span>,<span class="string">&#x27;2022-01&#x27;</span>,<span class="string">&#x27;2022-01-07&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">800</span>),</span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-02&#x27;</span>,<span class="string">&#x27;2022-02-01&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">100</span>),</span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-02&#x27;</span>,<span class="string">&#x27;2022-02-02&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">200</span>),</span><br><span class="line">                               (<span class="number">1</span>,<span class="string">&#x27;2022-02&#x27;</span>,<span class="string">&#x27;2022-02-03&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">300</span>),</span><br><span class="line">                               (<span class="number">2</span>,<span class="string">&#x27;2022-02&#x27;</span>,<span class="string">&#x27;2022-02-06&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">500</span>),</span><br><span class="line">                               (<span class="number">2</span>,<span class="string">&#x27;2022-02&#x27;</span>,<span class="string">&#x27;2022-02-07&#x27;</span>,<span class="string">&#x27;网购&#x27;</span>,<span class="number">800</span>);</span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> card_nbr,c_month,c_date <span class="keyword">from</span> c_t),</span><br><span class="line">     t2 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> card_nbr,c_month <span class="keyword">order</span> <span class="keyword">by</span> c_date) rn <span class="keyword">from</span> t1  ),</span><br><span class="line">     t3 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="operator">*</span>,date_sub(c_date,rn) dt2 <span class="keyword">from</span> t2  ),</span><br><span class="line">     t4 <span class="keyword">as</span> (<span class="keyword">select</span>  dt2,card_nbr,c_month,<span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> t3 <span class="keyword">group</span> <span class="keyword">by</span> dt2,card_nbr,c_month),</span><br><span class="line">     t5 <span class="keyword">as</span> ( <span class="keyword">select</span> <span class="operator">*</span>,<span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> card_nbr,c_month <span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) <span class="keyword">as</span> rn <span class="keyword">from</span> t4)</span><br><span class="line"><span class="keyword">select</span> card_nbr,c_month,cnt <span class="keyword">from</span> t5 <span class="keyword">where</span> rn<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>



<h2 id="N日留存率"><a href="#N日留存率" class="headerlink" title="N日留存率"></a>N日留存率</h2><ul>
<li><div align="left"><img src="images/1661067330554.png" style="zoom:60%;" /></div>
</li>
<li><p>核心代码</p>
</li>
<li><pre><code class="sql">-&gt; where 日期 in (首日,1天后,7天后)
-&gt; group by 用户
-&gt;count(if(日期=首日,1,null))  as cnt
  count(if(日期=1天后,1,null)) as cnt2
  count(if(日期=7天后,1,null)) as cnt8
-&gt;having cnt&gt;0
-&gt;count(user_id) as 首日总数
  count(if(cnt2&gt;0,1,null)) as 次日留存数
  count(if(cnt8&gt;0,1,null)) as 7日留存数
-&gt;次日留存数/首日总数 as 次日留存率
  7日留存数/首日总数 as 7日留存率
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* 先按用户分组，得到每个用户的各相关日期的登录情况。</span><br><span class="line"></span><br><span class="line">  * ```sql</span><br><span class="line">    select cuid,</span><br><span class="line">           count(if(event_day=&#x27;2020-04-01&#x27;,1,null)) as cnt,</span><br><span class="line">           count(if(event_day=&#x27;2020-04-02&#x27;,1,null)) as cnt2,</span><br><span class="line">           count(if(event_day=&#x27;2020-04-08&#x27;,1,null)) as cnt8</span><br><span class="line">      from tb_cuid_1d</span><br><span class="line">      --提前过滤数据</span><br><span class="line">      where event_day in (&#x27;2020-04-01&#x27;,&#x27;2020-04-02&#x27;,&#x27;2020-04-08&#x27;)</span><br><span class="line">    group by cuid</span><br><span class="line">    -- 2020-04-01必须登录，剔除掉2020-04-01没登录的</span><br><span class="line">    having cnt&gt;0</span><br></pre></td></tr></table></figure>

  效果如下

  &lt;div align=&quot;left&quot;&gt;&lt;img src=&quot;images/1659841600894.png&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;/div&gt;
</code></pre>
</li>
<li><p>再对上面的用户汇总</p>
<ul>
<li>&#96;&#96;&#96;sql<br>select count(cnt) as uv,<br>   count(if(cnt2!&#x3D;0,1,null)) as uv2,<br>   count(if(cnt8!&#x3D;0,1,null)) as uv8<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  * &lt;div align=&quot;left&quot;&gt;&lt;img src=&quot;images/1659841614840.png&quot; style=&quot;zoom:60%;&quot; /&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">* 最后再用 【后续日期的留存数】除以【首日总数】，就是【留存率】</span><br><span class="line"></span><br><span class="line">* 方案二</span><br><span class="line"></span><br><span class="line">  ```sql</span><br><span class="line">  select count(a.cuid) uv,</span><br><span class="line">         count(b.cuid) uv2,</span><br><span class="line">         count(c.cuid) uv7</span><br><span class="line">  from (select distinct event_day, cuid from tb_cuid_1d where event_day=&#x27;首日&#x27;) as a</span><br><span class="line">  left join (select distinct event_day, cuid from tb_cuid_1d where event_day=&#x27;次日&#x27;) as b on a.cuid=b.cuid</span><br><span class="line">  left join (select distinct event_day, cuid from tb_cuid_1d where event_day=&#x27;7日后&#x27;) as c on a.cuid=c.cuid;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="腾讯视频号游戏直播"><a href="#腾讯视频号游戏直播" class="headerlink" title="腾讯视频号游戏直播"></a>腾讯视频号游戏直播</h3><p>表：tableA </p>
<table>
<thead>
<tr>
<th>ds(日期)</th>
<th>device</th>
<th>user_id</th>
<th>is_active</th>
</tr>
</thead>
<tbody><tr>
<td>2020-03-01</td>
<td>ios</td>
<td>0001</td>
<td>0</td>
</tr>
<tr>
<td>2020–0301</td>
<td>ios</td>
<td>0002</td>
<td>1</td>
</tr>
<tr>
<td>2020-03-01</td>
<td>android</td>
<td>0003</td>
<td>1</td>
</tr>
<tr>
<td>2020-03-02</td>
<td>ios</td>
<td>0001</td>
<td>0</td>
</tr>
<tr>
<td>2020-03-02</td>
<td>ios</td>
<td>0002</td>
<td>0</td>
</tr>
<tr>
<td>2020-03-02</td>
<td>android</td>
<td>0003</td>
<td>1</td>
</tr>
</tbody></table>
<p> 20200301的ios设备用户活跃的次日留存率是多少？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">use test_sql;</span><br><span class="line"><span class="keyword">set</span> hive.exec.mode.local.auto<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">--腾讯视频号游戏直播</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> tableA;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tableA</span><br><span class="line">(ds string comment <span class="string">&#x27;(日期)&#x27;</span>  ,device string,user_id string,is_active <span class="type">int</span>) ;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span>  tableA <span class="keyword">values</span></span><br><span class="line">(<span class="string">&#x27;2020-03-01&#x27;</span>,<span class="string">&#x27;ios&#x27;</span>,<span class="string">&#x27;0001&#x27;</span>,<span class="number">0</span>),</span><br><span class="line">(<span class="string">&#x27;2020-03-01&#x27;</span>,<span class="string">&#x27;ios&#x27;</span>,<span class="string">&#x27;0002&#x27;</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;2020-03-01&#x27;</span>,<span class="string">&#x27;ios&#x27;</span>,<span class="string">&#x27;0004&#x27;</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;2020-03-01&#x27;</span>,<span class="string">&#x27;android&#x27;</span>,<span class="string">&#x27;0003&#x27;</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;2020-03-02&#x27;</span>,<span class="string">&#x27;ios&#x27;</span>,<span class="string">&#x27;0001&#x27;</span>,<span class="number">0</span>),</span><br><span class="line">(<span class="string">&#x27;2020-03-02&#x27;</span>,<span class="string">&#x27;ios&#x27;</span>,<span class="string">&#x27;0002&#x27;</span>,<span class="number">0</span>),</span><br><span class="line">(<span class="string">&#x27;2020-03-02&#x27;</span>,<span class="string">&#x27;android&#x27;</span>,<span class="string">&#x27;0003&#x27;</span>,<span class="number">1</span>),</span><br><span class="line">(<span class="string">&#x27;2020-03-02&#x27;</span>,<span class="string">&#x27;ios&#x27;</span>,<span class="string">&#x27;0005&#x27;</span>,<span class="number">1</span>) ,</span><br><span class="line">(<span class="string">&#x27;2020-03-02&#x27;</span>,<span class="string">&#x27;ios&#x27;</span>,<span class="string">&#x27;0004&#x27;</span>,<span class="number">1</span>) ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--方案1，过程见下面的顺序编号</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> user_id,</span><br><span class="line">           <span class="comment">--3-一个用户如果在&#x27;2020-03-01&#x27;活跃，则cnt1&gt;0</span></span><br><span class="line">           <span class="built_in">count</span>(if(ds <span class="operator">=</span> <span class="string">&#x27;2020-03-01&#x27;</span>, <span class="number">1</span>, <span class="keyword">null</span>)) cnt1,</span><br><span class="line">           <span class="comment">--4-一个用户如果在&#x27;2020-03-02&#x27;活跃，则cnt2&gt;0</span></span><br><span class="line">           <span class="built_in">count</span>(if(ds <span class="operator">=</span> <span class="string">&#x27;2020-03-02&#x27;</span>, <span class="number">1</span>, <span class="keyword">null</span>)) cnt2</span><br><span class="line">    <span class="keyword">from</span> tableA</span><br><span class="line">    <span class="comment">--1-预先全局过滤</span></span><br><span class="line">    <span class="keyword">where</span> device <span class="operator">=</span> <span class="string">&#x27;ios&#x27;</span></span><br><span class="line">      <span class="keyword">and</span> is_active <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">and</span> ds <span class="keyword">in</span> (<span class="string">&#x27;2020-03-01&#x27;</span>, <span class="string">&#x27;2020-03-02&#x27;</span>)</span><br><span class="line">    <span class="comment">--2-按用户分组</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br><span class="line">    <span class="comment">--6-只筛选&#x27;2020-03-01&#x27;活跃的用户，他在&#x27;2020-03-02&#x27;是否活跃，看cnt2=0则不活跃，&gt;0则活跃</span></span><br><span class="line">    <span class="keyword">having</span> cnt1 <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(cnt1)                               sum1,<span class="comment">--&#x27;2020-03-01&#x27;的活跃数</span></span><br><span class="line">       <span class="built_in">count</span>(if(cnt2 <span class="operator">&gt;</span> <span class="number">0</span>, user_id, <span class="keyword">null</span>))        sum2,<span class="comment">----并且在次日依然活跃的用户数</span></span><br><span class="line">       <span class="built_in">count</span>(if(cnt2 <span class="operator">&gt;</span> <span class="number">0</span>, user_id, <span class="keyword">null</span>)) <span class="operator">/</span> <span class="built_in">count</span>(cnt1) rate<span class="comment">--次日留存率</span></span><br><span class="line"><span class="keyword">from</span> t1;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="百度"><a href="#百度" class="headerlink" title="百度"></a>百度</h3><p>有两张表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> tb_cuid_1d</span><br><span class="line">(</span><br><span class="line">    cuid         string comment <span class="string">&#x27;用户的唯一标识&#x27;</span>,</span><br><span class="line">    os           string comment <span class="string">&#x27;平台&#x27;</span>,</span><br><span class="line">    soft_version string comment <span class="string">&#x27;版本&#x27;</span>,</span><br><span class="line">    event_day    string comment <span class="string">&#x27;日期&#x27;</span>,</span><br><span class="line">    <span class="type">timestamp</span>    <span class="type">int</span> comment <span class="string">&#x27;用户访问时间戳&#x27;</span>,</span><br><span class="line">    duration     <span class="type">decimal</span> comment <span class="string">&#x27;用户访问时长&#x27;</span>,</span><br><span class="line">    ext          <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span> comment <span class="string">&#x27;扩展字段&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> tb_cuid_1d <span class="keyword">values</span></span><br><span class="line"> (<span class="number">1</span>,<span class="string">&#x27;android&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2020-04-01&#x27;</span>,<span class="number">1234567</span>,<span class="number">100</span>,`<span class="keyword">array</span>`(<span class="string">&#x27;&#x27;</span>)),</span><br><span class="line"> (<span class="number">1</span>,<span class="string">&#x27;android&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2020-04-02&#x27;</span>,<span class="number">1234567</span>,<span class="number">100</span>,`<span class="keyword">array</span>`(<span class="string">&#x27;&#x27;</span>)),</span><br><span class="line"> (<span class="number">1</span>,<span class="string">&#x27;android&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2020-04-08&#x27;</span>,<span class="number">1234567</span>,<span class="number">100</span>,`<span class="keyword">array</span>`(<span class="string">&#x27;&#x27;</span>)),</span><br><span class="line"> (<span class="number">2</span>,<span class="string">&#x27;android&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2020-04-01&#x27;</span>,<span class="number">1234567</span>,<span class="number">100</span>,`<span class="keyword">array</span>`(<span class="string">&#x27;&#x27;</span>)),</span><br><span class="line"> (<span class="number">3</span>,<span class="string">&#x27;android&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;2020-04-02&#x27;</span>,<span class="number">1234567</span>,<span class="number">100</span>,`<span class="keyword">array</span>`(<span class="string">&#x27;&#x27;</span>));</span><br><span class="line"> </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> tb_account_1d</span><br><span class="line">(</span><br><span class="line">    cuid      string comment <span class="string">&#x27;用户的唯一标识&#x27;</span>,</span><br><span class="line">    uid       string comment <span class="string">&#x27;登入用户账号名&#x27;</span>,</span><br><span class="line">    event_day string comment <span class="string">&#x27;日期&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>写出用户表 tb_cuid_1d的 20200401 的次日、次7日留存的具体HQL ：</p>
<p>一条sql统计出以下指标 （4.1号uv，4.1号在4.2号的留存uv，4.1号在4.8号的留存uv）;</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--一个理解简单，但是性能不快的做法</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(a.cuid) uv,</span><br><span class="line">       <span class="built_in">count</span>(b.cuid) uv2,</span><br><span class="line">       <span class="built_in">count</span>(c.cuid) uv7</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> event_day, cuid <span class="keyword">from</span> tb_cuid_1d <span class="keyword">where</span> event_day<span class="operator">=</span><span class="string">&#x27;2020-04-01&#x27;</span>) <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> event_day, cuid <span class="keyword">from</span> tb_cuid_1d <span class="keyword">where</span> event_day<span class="operator">=</span><span class="string">&#x27;2020-04-02&#x27;</span>) <span class="keyword">as</span> b <span class="keyword">on</span> a.cuid<span class="operator">=</span>b.cuid</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="keyword">distinct</span> event_day, cuid <span class="keyword">from</span> tb_cuid_1d <span class="keyword">where</span> event_day<span class="operator">=</span><span class="string">&#x27;2020-04-08&#x27;</span>) <span class="keyword">as</span> c <span class="keyword">on</span> a.cuid<span class="operator">=</span>c.cuid;</span><br><span class="line"><span class="comment">--另一个理解稍微复杂，但是性能快的做法</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> cuid,</span><br><span class="line">           <span class="built_in">count</span>(if(event_day<span class="operator">=</span><span class="string">&#x27;2020-04-01&#x27;</span>,<span class="number">1</span>,<span class="keyword">null</span>)) <span class="keyword">as</span> cnt1,</span><br><span class="line">           <span class="built_in">count</span>(if(event_day<span class="operator">=</span><span class="string">&#x27;2020-04-02&#x27;</span>,<span class="number">1</span>,<span class="keyword">null</span>)) <span class="keyword">as</span> cnt2,</span><br><span class="line">           <span class="built_in">count</span>(if(event_day<span class="operator">=</span><span class="string">&#x27;2020-04-08&#x27;</span>,<span class="number">1</span>,<span class="keyword">null</span>)) <span class="keyword">as</span> cnt8</span><br><span class="line">     <span class="keyword">from</span> tb_cuid_1d</span><br><span class="line">     <span class="keyword">where</span> event_day <span class="keyword">in</span> (<span class="string">&#x27;2020-04-01&#x27;</span>,<span class="string">&#x27;2020-04-02&#x27;</span>,<span class="string">&#x27;2020-04-08&#x27;</span>)</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> cuid</span><br><span class="line">     <span class="keyword">having</span> cnt1 <span class="operator">&gt;</span><span class="number">0</span></span><br><span class="line">),</span><br><span class="line">     t2 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="built_in">count</span>(cuid)                  <span class="keyword">as</span> uv1,</span><br><span class="line">                   <span class="built_in">count</span>(if(cnt2 <span class="operator">&gt;</span> <span class="number">0</span>, <span class="number">1</span>, <span class="keyword">null</span>)) <span class="keyword">as</span> uv2,</span><br><span class="line">                   <span class="built_in">count</span>(if(cnt8 <span class="operator">&gt;</span> <span class="number">0</span>, <span class="number">1</span>, <span class="keyword">null</span>)) <span class="keyword">as</span> uv7</span><br><span class="line">            <span class="keyword">from</span> t1</span><br><span class="line">            )</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">       uv2 <span class="operator">/</span> uv1 <span class="keyword">as</span> `次日留存率`,</span><br><span class="line">       uv7 <span class="operator">/</span> uv1 <span class="keyword">as</span> `<span class="number">7</span>日留存率`</span><br><span class="line"><span class="keyword">from</span> t2</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="分组内top前几"><a href="#分组内top前几" class="headerlink" title="分组内top前几"></a>分组内top前几</h2><ul>
<li><p>需求常见词： </p>
<ul>
<li><p>【每组xxx内按yyy排序的前n个zzz】</p>
</li>
<li><p>【每组xxx内按yyy排序的第1个zzz】</p>
</li>
<li><p>【每组xxx内按yyy排序的最后1个zzz】</p>
</li>
<li><p>特点是yyy和zzz是不同的字段。</p>
</li>
<li><p>比如：班内按性别分组，组内按身高排序，的前3个学生姓名</p>
</li>
</ul>
</li>
<li><p>公式：row_number() over(partition by 组名 order by yyy)  as rn，再筛选rn&lt;&#x3D;N名</p>
</li>
</ul>
<h3 id="跨越物流"><a href="#跨越物流" class="headerlink" title="跨越物流"></a>跨越物流</h3><p>员工表结构</p>
<div align="left"><img src="images/1659691092883.png" style="zoom:40%;" /></div>

 

<p>员工表数据</p>
<div align="left"><img src="images/1659691114602.png" style="zoom:40%;" /></div>

 

<p>题目描述</p>
<p>求出每个部门工资最高的前三名员工，并计算这些员工的工资占所属部门总工资的百分比。</p>
<p>结果</p>
<p><img src="E:\自研项目\sql资料\4\images\1659691126801.png" alt="1659691126801"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp(empno string ,ename string,hiredate string,sal <span class="type">int</span> ,deptno string);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> emp <span class="keyword">values</span></span><br><span class="line">(<span class="string">&#x27;7521&#x27;</span>, <span class="string">&#x27;WARD&#x27;</span>, <span class="string">&#x27;1981-2-22&#x27;</span>, <span class="number">1250</span>, <span class="number">30</span>),</span><br><span class="line">(<span class="string">&#x27;7566&#x27;</span>, <span class="string">&#x27;JONES&#x27;</span>, <span class="string">&#x27;1981-4-2&#x27;</span>, <span class="number">2975</span>, <span class="number">20</span>),</span><br><span class="line">(<span class="string">&#x27;7876&#x27;</span>, <span class="string">&#x27;ADAMS&#x27;</span>, <span class="string">&#x27;1987-7-13&#x27;</span>, <span class="number">1100</span>, <span class="number">20</span>),</span><br><span class="line">(<span class="string">&#x27;7369&#x27;</span>, <span class="string">&#x27;SMITH&#x27;</span>, <span class="string">&#x27;1980-12-17&#x27;</span>, <span class="number">800</span>, <span class="number">20</span>),</span><br><span class="line">(<span class="string">&#x27;7934&#x27;</span>, <span class="string">&#x27;MILLER&#x27;</span>, <span class="string">&#x27;1982-1-23&#x27;</span>, <span class="number">1300</span>, <span class="number">10</span>),</span><br><span class="line">(<span class="string">&#x27;7844&#x27;</span>, <span class="string">&#x27;TURNER&#x27;</span>, <span class="string">&#x27;1981-9-8&#x27;</span>, <span class="number">1500</span>, <span class="number">30</span>),</span><br><span class="line">(<span class="string">&#x27;7782&#x27;</span>, <span class="string">&#x27;CLARK&#x27;</span>, <span class="string">&#x27;1981-6-9&#x27;</span>, <span class="number">2450</span>, <span class="number">10</span>),</span><br><span class="line">(<span class="string">&#x27;7839&#x27;</span>, <span class="string">&#x27;KING&#x27;</span>, <span class="string">&#x27;1981-11-17&#x27;</span>, <span class="number">5000</span>, <span class="number">10</span>),</span><br><span class="line">(<span class="string">&#x27;7902&#x27;</span>, <span class="string">&#x27;FORD&#x27;</span>, <span class="string">&#x27;1981-12-3&#x27;</span>, <span class="number">3000</span>, <span class="number">20</span>),</span><br><span class="line">(<span class="string">&#x27;7499&#x27;</span>, <span class="string">&#x27;ALLEN&#x27;</span>, <span class="string">&#x27;1981-2-20&#x27;</span>, <span class="number">1600</span>, <span class="number">30</span>),</span><br><span class="line">(<span class="string">&#x27;7654&#x27;</span>, <span class="string">&#x27;MARTIN&#x27;</span>, <span class="string">&#x27;1981-9-28&#x27;</span>, <span class="number">1250</span>, <span class="number">30</span>),</span><br><span class="line">(<span class="string">&#x27;7900&#x27;</span>, <span class="string">&#x27;JAMES&#x27;</span>, <span class="string">&#x27;1981-12-3&#x27;</span>, <span class="number">950</span>, <span class="number">30</span>),</span><br><span class="line">(<span class="string">&#x27;7788&#x27;</span>, <span class="string">&#x27;SCOTT&#x27;</span>, <span class="string">&#x27;1987-7-13&#x27;</span>, <span class="number">3000</span>, <span class="number">20</span>),</span><br><span class="line">(<span class="string">&#x27;7698&#x27;</span>, <span class="string">&#x27;BLAKE&#x27;</span>, <span class="string">&#x27;1981-5-1&#x27;</span>, <span class="number">2850</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="comment">--求出每个部门工资最高的前三名员工，并计算这些员工的工资占所属部门总工资的百分比。</span></span><br><span class="line"><span class="keyword">select</span> a.empno,</span><br><span class="line">       a.sal,</span><br><span class="line">       a.deptno,</span><br><span class="line">       a.rn,</span><br><span class="line">       a.sum_sal,</span><br><span class="line">       round(a.sal<span class="operator">/</span>a.sum_sal,<span class="number">2</span>) <span class="keyword">as</span> rate</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line"><span class="comment">--每个部门工资排名</span></span><br><span class="line">         <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> deptno <span class="keyword">order</span> <span class="keyword">by</span> sal <span class="keyword">desc</span>) <span class="keyword">as</span> rn, </span><br><span class="line"><span class="comment">--每个部门的总工资</span></span><br><span class="line">         <span class="built_in">sum</span>(sal) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> deptno ) <span class="keyword">as</span> sum_sal </span><br><span class="line"><span class="keyword">from</span> emp) a</span><br><span class="line"><span class="keyword">where</span> rn<span class="operator">&lt;=</span><span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h3 id="小米电商"><a href="#小米电商" class="headerlink" title="小米电商"></a>小米电商</h3><p>订单表，torder.  字段，user_id, order_id, ctime(10位时间戳)，city id，sale_num，sku_id(商品)</p>
<p>问题：20201201至今每日订单量top10的城市及其订单量(订单量对order id去重)(在线写)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_order (user_id string, </span><br><span class="line">                      order_id string, </span><br><span class="line">                      ctime string, </span><br><span class="line">                      city_id string, </span><br><span class="line">                      sale_num <span class="type">int</span> , </span><br><span class="line">                      sku_id string) ;</span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (<span class="keyword">select</span> to_date(ctime) cdate, city_id, <span class="built_in">count</span>(<span class="keyword">distinct</span> order_id) cnt</span><br><span class="line">            <span class="keyword">from</span> t_order</span><br><span class="line">            <span class="keyword">where</span> to_date(ctime) <span class="operator">&gt;=</span> <span class="string">&#x27;2020-12-01&#x27;</span></span><br><span class="line">              <span class="keyword">and</span> to_date(ctime) <span class="operator">&lt;=</span> `<span class="built_in">current_date</span>`()</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> to_date(ctime), city_id),</span><br><span class="line">     t2 <span class="keyword">as</span> (<span class="keyword">select</span> <span class="operator">*</span>, <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> cdate <span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) rn <span class="keyword">from</span> t1)</span><br><span class="line"><span class="keyword">select</span> cdate, city_id, cnt</span><br><span class="line"><span class="keyword">from</span> t2</span><br><span class="line"><span class="keyword">where</span> rn <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>



<h2 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h2><ul>
<li><p>窗口函数的最大特点是有over()关键字</p>
</li>
<li><p>聚合类的窗口函数</p>
<ul>
<li>sum() over()</li>
<li>count&#x2F;avg&#x2F;max&#x2F;min</li>
</ul>
</li>
<li><p>排序类的窗口函数</p>
<ul>
<li>row_number，rank，dense_rank</li>
</ul>
</li>
<li><p>偏移类的，跨行的</p>
<ul>
<li>lag &#x2F; lead</li>
</ul>
</li>
<li><p>first_value&#x2F;last_value</p>
</li>
<li><p>ntile</p>
</li>
</ul>
<h3 id="交通银行"><a href="#交通银行" class="headerlink" title="交通银行"></a>交通银行</h3><p>Emp表的表数据如下：</p>
<table>
<thead>
<tr>
<th>NAME</th>
<th>MONTH</th>
<th>AMT</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>01</td>
<td>100</td>
</tr>
<tr>
<td>李四</td>
<td>02</td>
<td>120</td>
</tr>
<tr>
<td>王五</td>
<td>03</td>
<td>150</td>
</tr>
<tr>
<td>赵六</td>
<td>04</td>
<td>500</td>
</tr>
<tr>
<td>张三</td>
<td>05</td>
<td>400</td>
</tr>
<tr>
<td>李四</td>
<td>06</td>
<td>350</td>
</tr>
<tr>
<td>王五</td>
<td>07</td>
<td>180</td>
</tr>
<tr>
<td>赵六</td>
<td>08</td>
<td>400</td>
</tr>
</tbody></table>
<p>问题：请写出可以得到以下的结果SQL</p>
<table>
<thead>
<tr>
<th>NAME</th>
<th>总金额</th>
<th>排名</th>
<th>占比</th>
</tr>
</thead>
<tbody><tr>
<td>赵六</td>
<td>900</td>
<td>1</td>
<td>40.91%</td>
</tr>
<tr>
<td>张三</td>
<td>500</td>
<td>2</td>
<td>22.73%</td>
</tr>
<tr>
<td>李四</td>
<td>470</td>
<td>3</td>
<td>21.36%</td>
</tr>
<tr>
<td>王五</td>
<td>330</td>
<td>4</td>
<td>15.00%</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp(name string , <span class="keyword">month</span> string, amt <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> emp <span class="keyword">values</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;01&#x27;</span>, <span class="number">100</span>),</span><br><span class="line">       (<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;02&#x27;</span>, <span class="number">120</span>),</span><br><span class="line">       (<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;03&#x27;</span>, <span class="number">150</span>),</span><br><span class="line">       (<span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;04&#x27;</span>, <span class="number">500</span>),</span><br><span class="line">       (<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;05&#x27;</span>, <span class="number">400</span>),</span><br><span class="line">       (<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;06&#x27;</span>, <span class="number">350</span>),</span><br><span class="line">       (<span class="string">&#x27;王五&#x27;</span>, <span class="string">&#x27;07&#x27;</span>, <span class="number">180</span>),</span><br><span class="line">       (<span class="string">&#x27;赵六&#x27;</span>, <span class="string">&#x27;08&#x27;</span>, <span class="number">400</span>);</span><br><span class="line"><span class="comment">--rank 1224</span></span><br><span class="line"><span class="comment">--dense_rank 1223</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span> (<span class="keyword">select</span> name,</span><br><span class="line">                   <span class="built_in">sum</span>(amt) <span class="keyword">as</span> sum_amt</span><br><span class="line">            <span class="keyword">from</span> emp</span><br><span class="line">            <span class="keyword">group</span> <span class="keyword">by</span> name),</span><br><span class="line">     t2 <span class="keyword">as</span> (</span><br><span class="line">         <span class="keyword">select</span> name,</span><br><span class="line">                sum_amt,</span><br><span class="line">                <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> sum_amt <span class="keyword">desc</span>) rn,</span><br><span class="line">                sum_amt<span class="operator">/</span><span class="built_in">sum</span>(sum_amt) <span class="keyword">over</span> () <span class="keyword">as</span> rate</span><br><span class="line">         <span class="keyword">from</span> t1</span><br><span class="line">     )</span><br><span class="line"><span class="keyword">select</span> name, sum_amt, rn, concat(round(rate<span class="operator">*</span><span class="number">100</span>,<span class="number">2</span>),<span class="string">&#x27;%&#x27;</span>) rate <span class="keyword">from</span> t2</span><br></pre></td></tr></table></figure>



<h3 id="跨越物流-1"><a href="#跨越物流-1" class="headerlink" title="跨越物流"></a>跨越物流</h3><p>题目描述</p>
<p>在第一题员工表的基础上，统计每年入职总数以及截至本年累计入职总人数。</p>
<p>截至本年累计入职总人数&#x3D;本年总入职人数 + 本年之前所有年的总入职人数之和</p>
<p>结果</p>
<div align="left"><img src="images/1659701581524.png" style="zoom:40%;" /></div>

 

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span>,</span><br><span class="line">       <span class="built_in">sum</span>(cnt) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> year1) cnt2</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span> <span class="keyword">year</span>(hiredate) <span class="keyword">as</span> year1,</span><br><span class="line">       <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> emp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">year</span>(hiredate)) a;</span><br></pre></td></tr></table></figure>



<h2 id="带条件的聚合统计"><a href="#带条件的聚合统计" class="headerlink" title="带条件的聚合统计"></a>带条件的聚合统计</h2><ul>
<li>一般的做法是group by xx,yy  再多次的sum(if(……))</li>
<li>好处是避免多次加载表，一次性得到多个指标，可以只加载一次表就得到多个指标。</li>
</ul>
<h3 id="腾讯数据提取"><a href="#腾讯数据提取" class="headerlink" title="腾讯数据提取"></a>腾讯数据提取</h3><p>用户行为表：t_user_video_action_d分区：ds（格式 yyyyMMdd）</p>
<p>主键：user_id、video_id</p>
<p>含义：一个 user 对一个视频的所有行为聚合，每天增量字段：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段含义</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>user_id</td>
<td>用户 id</td>
<td>string</td>
</tr>
<tr>
<td>video_id</td>
<td>视频 id</td>
<td>string</td>
</tr>
<tr>
<td>expose_cnt</td>
<td>曝光次数</td>
<td>int</td>
</tr>
<tr>
<td>like_cnt</td>
<td>点赞次数</td>
<td>int</td>
</tr>
</tbody></table>
<p>视频表：t_video_d</p>
<p>分区：ds（格式 yyyyMMdd）主键：video_id</p>
<p>含义：当天全量视频数据字段：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段含义</th>
<th>类型</th>
<th>枚举</th>
</tr>
</thead>
<tbody><tr>
<td>video_id</td>
<td>视频 id</td>
<td>string</td>
<td></td>
</tr>
<tr>
<td>video_type</td>
<td>视频类型</td>
<td>string</td>
<td>娱乐、新闻、搞笑</td>
</tr>
<tr>
<td>video_user_id</td>
<td>视频创建者 user_id</td>
<td>string</td>
<td></td>
</tr>
<tr>
<td>video_create_time</td>
<td>视频创建时间</td>
<td>bigint</td>
<td></td>
</tr>
</tbody></table>
<p>​	</p>
<p>作者表：t_video_user_d</p>
<p>分区：ds（格式 yyyyMMdd）主键：video_user_id</p>
<p>含义：当天全量视频创建者数据</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段含义</th>
<th>类型</th>
<th>枚举</th>
</tr>
</thead>
<tbody><tr>
<td>video_user_id</td>
<td>视频创建者 user_id</td>
<td>string</td>
<td></td>
</tr>
<tr>
<td>video_user_name</td>
<td>名称</td>
<td>string</td>
<td></td>
</tr>
<tr>
<td>video_user_type</td>
<td>视频创建者类型</td>
<td>string</td>
<td>娱乐、新闻、搞笑</td>
</tr>
</tbody></table>
<p>需求方需要视频号搞笑类型视频的曝光点赞时长等数据，请提供一张 ads 表。搞笑类型视频定义：视频类型为搞笑或者视频创建者类型为搞笑</p>
<p>需要产出字段：视频 id，视频创建者 user_id，视频创建者名称、当天曝光次数、当天点赞次数、近 30 天曝光次数、近 30 天点赞次数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> t_user_video_action_d</span><br><span class="line">(</span><br><span class="line">    user_id    string comment &quot;用户id&quot;,</span><br><span class="line">    video_id   string comment &quot;视频id&quot;,</span><br><span class="line">    expose_cnt <span class="type">int</span> comment &quot;曝光次数&quot;,</span><br><span class="line">    like_cnt   <span class="type">int</span> comment &quot;点赞次数&quot;</span><br><span class="line">) partitioned <span class="keyword">by</span> (ds string);</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> t_video_d;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> t_video_d</span><br><span class="line">(</span><br><span class="line">    video_id          string comment <span class="string">&#x27;视频id&#x27;</span>,</span><br><span class="line">    video_type        string comment <span class="string">&#x27;视频类型&#x27;</span>,</span><br><span class="line">    video_user_id     string comment <span class="string">&#x27;视频创建者user_id&#x27;</span>,</span><br><span class="line">    video_create_time <span class="type">bigint</span> comment <span class="string">&#x27;视频创建时间&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (ds string);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> t_video_user_d</span><br><span class="line">(</span><br><span class="line">    video_user_id   string comment <span class="string">&#x27;视频创建者user_id&#x27;</span>,</span><br><span class="line">    video_user_name string comment <span class="string">&#x27;名称&#x27;</span>,</span><br><span class="line">    video_user_type string comment <span class="string">&#x27;视频创建者类型&#x27;</span></span><br><span class="line">) partitioned <span class="keyword">by</span> (ds string);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--假设当天是2022-07-31</span></span><br><span class="line"><span class="keyword">select</span> t1.<span class="operator">*</span>,</span><br><span class="line">       t2.video_user_id,</span><br><span class="line">       t2.video_user_name</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> video_id,</span><br><span class="line">             <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> ds <span class="operator">=</span> <span class="string">&#x27;2022-07-30&#x27;</span> <span class="keyword">then</span> expose_cnt <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>),<span class="comment">--当天曝光次数、</span></span><br><span class="line">             <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> ds <span class="operator">=</span> <span class="string">&#x27;2022-07-30&#x27;</span> <span class="keyword">then</span> like_cnt <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>),<span class="comment">-- 当天点赞次数、</span></span><br><span class="line">             <span class="built_in">sum</span>(expose_cnt) <span class="keyword">as</span> sum_expose,<span class="comment">-- 近 30 天曝光次数、</span></span><br><span class="line">             <span class="built_in">sum</span>(like_cnt)<span class="comment">-- 近 30 天点赞次数</span></span><br><span class="line">      <span class="keyword">from</span> t_user_video_action_d</span><br><span class="line">      <span class="keyword">where</span> ds <span class="keyword">between</span> <span class="string">&#x27;2022-07-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2022-07-30&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> video_id) <span class="keyword">as</span> t1</span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> d.video_id, d.video_user_id, u.video_user_name</span><br><span class="line">   <span class="keyword">from</span> t_video_d d</span><br><span class="line">   <span class="keyword">join</span> t_video_user_d u <span class="keyword">on</span> d.video_user_id <span class="operator">=</span> u.video_user_id</span><br><span class="line">   <span class="keyword">where</span> (d.video_type <span class="keyword">like</span> <span class="string">&#x27;%搞笑%&#x27;</span> <span class="keyword">or</span> u.video_user_type <span class="keyword">like</span> <span class="string">&#x27;%搞笑%&#x27;</span>)</span><br><span class="line">     <span class="keyword">and</span> d.ds <span class="operator">=</span> <span class="string">&#x27;2022-07-30&#x27;</span></span><br><span class="line">     <span class="keyword">and</span> u.ds <span class="operator">=</span> <span class="string">&#x27;2022-07-30&#x27;</span>) <span class="keyword">as</span> t2 <span class="keyword">on</span> t1.video_id <span class="operator">=</span> t2.video_id</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="小米电商-1"><a href="#小米电商-1" class="headerlink" title="小米电商"></a>小米电商</h3><p>要求：编写SQL能运行，数据正确且符合规范，如遇到自定义函数或不记得的函数可以用XX代替</p>
<p>1.已知有如下两个表表sale：字段如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> sale_order(</span><br><span class="line">    Order_id <span class="type">bigint</span> comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    User_id <span class="type">bigint</span> comment <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">    Order_status <span class="type">int</span>,</span><br><span class="line">    Create_time string,</span><br><span class="line">    Last_update_time string,</span><br><span class="line">    Product_id <span class="type">bigint</span>,</span><br><span class="line">    Product_num <span class="type">bigint</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>用户注册表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">table</span> user_info(</span><br><span class="line">    user_id <span class="type">bigint</span> comment<span class="string">&#x27;用户ID，唯一主键&#x27;</span>,</span><br><span class="line">    sex string.</span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>问题：用一条SQL生成完整的用户画像表，包含如下字段：</p>
<p>user_id,  sex,  age,  d7order_num,   d14_order_num，后面两个字段分别为近7天订单数量，近14天订单数量。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sale_order(</span><br><span class="line">    order_id <span class="type">bigint</span> comment <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    user_id <span class="type">bigint</span> comment <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">    order_status <span class="type">int</span> ,</span><br><span class="line">    create_time string,</span><br><span class="line">    last_update_time string,</span><br><span class="line">    product_id <span class="type">bigint</span>,</span><br><span class="line">    product_num <span class="type">bigint</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_info(</span><br><span class="line">    user_id <span class="type">bigint</span> comment <span class="string">&#x27;用户ID,唯一主键&#x27;</span>,</span><br><span class="line">    sex string,</span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> u.user_id,</span><br><span class="line">       s.d7order_num,</span><br><span class="line">       s.d14order_num</span><br><span class="line"><span class="keyword">from</span> user_info u</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> user_id,</span><br><span class="line">                  <span class="built_in">count</span>(if(create_time <span class="operator">&gt;=</span> <span class="string">&#x27;7天前&#x27;</span>  <span class="keyword">and</span> create_time <span class="operator">&lt;=</span> <span class="string">&#x27;今天&#x27;</span>, order_id,<span class="keyword">null</span>)) <span class="keyword">as</span> d7order_num,</span><br><span class="line">                  <span class="built_in">count</span>(if(create_time <span class="operator">&gt;=</span> <span class="string">&#x27;14天前&#x27;</span> <span class="keyword">and</span> create_time <span class="operator">&lt;=</span> <span class="string">&#x27;今天&#x27;</span>, order_id,<span class="keyword">null</span>)) <span class="keyword">as</span> d14order_num</span><br><span class="line">           <span class="keyword">from</span> sale_order</span><br><span class="line">           <span class="keyword">where</span> create_time <span class="operator">&gt;=</span> <span class="string">&#x27;14天前&#x27;</span></span><br><span class="line">           <span class="keyword">group</span> <span class="keyword">by</span> user_id) s <span class="keyword">on</span> u.user_id <span class="operator">=</span> s.user_id;</span><br></pre></td></tr></table></figure>



<h2 id="join系列"><a href="#join系列" class="headerlink" title="join系列"></a>join系列</h2><p>【区分 inner &#x2F;left &#x2F; right &#x2F; full &#x2F; left semi &#x2F; left anti join 的特点】</p>
<p>有以下银行信息表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">use interview_db;</span><br><span class="line"><span class="keyword">set</span> hive.exec.mode.local.auto<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> all_users;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> all_users(</span><br><span class="line">    id <span class="type">int</span> comment <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    name string comment <span class="string">&#x27;用户姓名&#x27;</span>,</span><br><span class="line">    sex string comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    age <span class="type">int</span> comment <span class="string">&#x27;年龄&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;银行用户信息表&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> all_users <span class="keyword">values</span></span><br><span class="line">(<span class="number">1</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="number">20</span>),</span><br><span class="line">(<span class="number">2</span>,<span class="string">&#x27;李四&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="number">29</span>),</span><br><span class="line">(<span class="number">3</span>,<span class="string">&#x27;王五&#x27;</span>,<span class="string">&#x27;男&#x27;</span>,<span class="number">21</span>),</span><br><span class="line">(<span class="number">4</span>,<span class="string">&#x27;赵六&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="number">28</span>),</span><br><span class="line">(<span class="number">5</span>,<span class="string">&#x27;田七&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="number">22</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> black_list;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> black_list(</span><br><span class="line">    user_id <span class="type">int</span> comment <span class="string">&#x27;用户编号&#x27;</span>,</span><br><span class="line">    type string comment <span class="string">&#x27;风控类型&#x27;</span></span><br><span class="line">)comment <span class="string">&#x27;银行黑名单信息表&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> black_list <span class="keyword">values</span></span><br><span class="line">(<span class="number">1</span>,<span class="string">&#x27;诈骗&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>,<span class="string">&#x27;逾期&#x27;</span>),</span><br><span class="line">(<span class="number">3</span>,<span class="string">&#x27;套现&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="left-join"><a href="#left-join" class="headerlink" title="left join"></a>left join</h3><p>使用left join对所有用户，如果也在黑名单中，则标记为YES，否则标记为NO。</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">sex</th>
<th align="left">age</th>
<th align="left">flag</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">张三</td>
<td align="left">男</td>
<td align="left">20</td>
<td align="left">YES</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">李四</td>
<td align="left">男</td>
<td align="left">29</td>
<td align="left">YES</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">王五</td>
<td align="left">男</td>
<td align="left">21</td>
<td align="left">YES</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">赵六</td>
<td align="left">女</td>
<td align="left">28</td>
<td align="left">NO</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">田七</td>
<td align="left">女</td>
<td align="left">22</td>
<td align="left">NO</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.<span class="operator">*</span>,</span><br><span class="line">       if(b.user_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>, <span class="string">&#x27;YES&#x27;</span>, <span class="string">&#x27;NO&#x27;</span>) flag</span><br><span class="line"><span class="keyword">from</span> all_users a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> black_list b</span><br><span class="line"><span class="keyword">on</span> a.id <span class="operator">=</span> b.user_id;</span><br></pre></td></tr></table></figure>

<h3 id="right-join"><a href="#right-join" class="headerlink" title="right join"></a>right join</h3><p>对上面的问题，使用right join再做一次。</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">sex</th>
<th align="left">age</th>
<th align="left">flag</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">张三</td>
<td align="left">男</td>
<td align="left">20</td>
<td align="left">YES</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">李四</td>
<td align="left">男</td>
<td align="left">29</td>
<td align="left">YES</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">王五</td>
<td align="left">男</td>
<td align="left">21</td>
<td align="left">YES</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">赵六</td>
<td align="left">女</td>
<td align="left">28</td>
<td align="left">NO</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">田七</td>
<td align="left">女</td>
<td align="left">22</td>
<td align="left">NO</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> b.<span class="operator">*</span>,</span><br><span class="line">       if(a.user_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>, <span class="string">&#x27;YES&#x27;</span>, <span class="string">&#x27;NO&#x27;</span>) flag</span><br><span class="line"><span class="keyword">from</span> black_list a</span><br><span class="line"><span class="keyword">right</span> <span class="keyword">join</span> all_users b</span><br><span class="line"><span class="keyword">on</span> a.user_id <span class="operator">=</span> b.id;</span><br></pre></td></tr></table></figure>

<h3 id="left-semi-join"><a href="#left-semi-join" class="headerlink" title="left semi join"></a>left semi join</h3><p>使用left semi join对所有用户，如果也在黑名单中，则挑选出来。</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">sex</th>
<th align="left">age</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">张三</td>
<td align="left">男</td>
<td align="left">20</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">李四</td>
<td align="left">男</td>
<td align="left">29</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">王五</td>
<td align="left">男</td>
<td align="left">21</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> all_users a</span><br><span class="line"><span class="keyword">left</span> semi <span class="keyword">join</span> black_list b</span><br><span class="line"><span class="keyword">on</span> a.id <span class="operator">=</span> b.user_id;</span><br></pre></td></tr></table></figure>

<h3 id="left-anti-join"><a href="#left-anti-join" class="headerlink" title="left anti join"></a>left anti join</h3><p>使用left anti join对所有用户，如果不在黑名单中，则挑选出来。</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">sex</th>
<th align="left">age</th>
</tr>
</thead>
<tbody><tr>
<td align="left">4</td>
<td align="left">赵六</td>
<td align="left">女</td>
<td align="left">28</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">田七</td>
<td align="left">女</td>
<td align="left">22</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> all_users a</span><br><span class="line"><span class="keyword">left</span> anti <span class="keyword">join</span> black_list b</span><br><span class="line"><span class="keyword">on</span> a.id <span class="operator">=</span> b.user_id;</span><br></pre></td></tr></table></figure>

<h3 id="full-join"><a href="#full-join" class="headerlink" title="full join"></a>full join</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--用户的存款金额。</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> deposit;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> deposit (</span><br><span class="line">    user_id <span class="type">int</span> comment <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    amount <span class="type">int</span> comment <span class="string">&#x27;存款金额&#x27;</span></span><br><span class="line">)comment <span class="string">&#x27;用户最新银行存款信息表&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> deposit <span class="keyword">values</span></span><br><span class="line">(<span class="number">1</span>,<span class="number">2000</span>),</span><br><span class="line">(<span class="number">2</span>,<span class="number">2900</span>),</span><br><span class="line">(<span class="number">3</span>,<span class="number">2100</span>);</span><br><span class="line"><span class="comment">--用户的负债金额。</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> debt;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> debt (</span><br><span class="line">    user_id <span class="type">int</span> comment <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">    amount <span class="type">int</span> comment <span class="string">&#x27;负债金额&#x27;</span></span><br><span class="line">)comment <span class="string">&#x27;用户最新银行负债信息表&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> debt <span class="keyword">values</span></span><br><span class="line">(<span class="number">3</span>,<span class="number">3400</span>),</span><br><span class="line">(<span class="number">4</span>,<span class="number">2800</span>),</span><br><span class="line">(<span class="number">5</span>,<span class="number">2200</span>);</span><br></pre></td></tr></table></figure>

<p>使用full join，展示用户的存款金额和负债金额。</p>
<table>
<thead>
<tr>
<th align="left">user_id</th>
<th align="left">deposit_amount</th>
<th align="left">debt_amount</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">2000</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">2900</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">2100</td>
<td align="left">3400</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">0</td>
<td align="left">2800</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">0</td>
<td align="left">2200</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">coalesce</span>(a.user_id, b.user_id) <span class="keyword">as</span> user_id,</span><br><span class="line">       <span class="built_in">coalesce</span>(a.amount, <span class="number">0</span>)          <span class="keyword">as</span> deposit_amount,</span><br><span class="line">       <span class="built_in">coalesce</span>(b.amount, <span class="number">0</span>)          <span class="keyword">as</span> debt_amount</span><br><span class="line"><span class="keyword">from</span> deposit a</span><br><span class="line"><span class="keyword">full</span> <span class="keyword">join</span> debt b</span><br><span class="line"><span class="keyword">on</span> a.user_id <span class="operator">=</span> b.user_id;</span><br></pre></td></tr></table></figure>



<h3 id="字节跳动"><a href="#字节跳动" class="headerlink" title="字节跳动"></a>字节跳动</h3><p>【考察full join】</p>
<p>1、某个游戏中的元宝分为，付费元宝和免费元宝。玩家购买商城道具时候，可以使用付费元宝也可以使用免费元宝。请使用HIve SQL语句计算出2021-01-01至2021-01-07期间各个角色当日消耗元宝的付费免费比例（付费免费比 &#x3D; 付费元宝消耗量 &#x2F; 免费元宝消耗量）。</p>
<p>现有表结构如下：</p>
<table>
<thead>
<tr>
<th>desc</th>
<th>dm_paid_buy;</th>
</tr>
</thead>
<tbody><tr>
<td>#dm_paid_buy</td>
<td>角色使用付费元宝购买商城道具时候记录一条</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>time</th>
<th>bigint</th>
<th>#购买的时间戳</th>
</tr>
</thead>
<tbody><tr>
<td>server_id</td>
<td>string</td>
<td>#服务器ID</td>
</tr>
<tr>
<td>role_id</td>
<td>int</td>
<td>#角色ID</td>
</tr>
<tr>
<td>cost</td>
<td>int</td>
<td>#购买对应道具消耗的付费元宝数量</td>
</tr>
<tr>
<td>item_id</td>
<td>int</td>
<td>#购买对应道具的id</td>
</tr>
<tr>
<td>amount</td>
<td>int</td>
<td>#购买对应道具的数量</td>
</tr>
<tr>
<td>p_date</td>
<td>string</td>
<td>#登录日期,yyyy-MM-dd</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>desc</th>
<th>dm_free_buy;</th>
</tr>
</thead>
<tbody><tr>
<td>#dm_free_buy</td>
<td>角色使用免费元宝购买商城道具时候记录一条</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>time</th>
<th>bigint</th>
<th>#购买的时间戳</th>
</tr>
</thead>
<tbody><tr>
<td>server_id</td>
<td>string</td>
<td>#服务器ID</td>
</tr>
<tr>
<td>role_id</td>
<td>int</td>
<td>#角色ID</td>
</tr>
<tr>
<td>cost</td>
<td>int</td>
<td>#购买对应道具消耗的免费元宝数量</td>
</tr>
<tr>
<td>item_id</td>
<td>int</td>
<td>#购买对应道具的id</td>
</tr>
<tr>
<td>amount</td>
<td>int</td>
<td>#购买对应道具的数量</td>
</tr>
<tr>
<td>p_date</td>
<td>string</td>
<td>#登录日期,yyyy-MM-dd</td>
</tr>
</tbody></table>
<p>示例：</p>
<p>结果输出</p>
<table>
<thead>
<tr>
<th>p_date</th>
<th>server_id</th>
<th>role_id</th>
<th>付费免费比</th>
</tr>
</thead>
<tbody><tr>
<td>2021-01-01</td>
<td>123</td>
<td>10098</td>
<td>0</td>
</tr>
<tr>
<td>2021-01-01</td>
<td>120</td>
<td>10098</td>
<td>0.4</td>
</tr>
<tr>
<td>2021-01-02</td>
<td>123</td>
<td>10098</td>
<td>0.2</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">use interview_db;</span><br><span class="line"><span class="keyword">set</span> hive.exec.mode.local.auto<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dm_paid_buy</span><br><span class="line">(</span><br><span class="line">    `<span class="type">time</span>`    <span class="type">bigint</span> comment <span class="string">&#x27;#购买的时间戳&#x27;</span>,</span><br><span class="line">    server_id string comment <span class="string">&#x27;#服务器ID&#x27;</span>,</span><br><span class="line">    role_id   <span class="type">int</span> comment <span class="string">&#x27;#角色ID&#x27;</span>,</span><br><span class="line">    cost      <span class="type">int</span> comment <span class="string">&#x27;#购买对应道具消耗的付费元宝数量&#x27;</span>,</span><br><span class="line">    item_id   <span class="type">int</span> comment <span class="string">&#x27;#购买对应道具的id&#x27;</span>,</span><br><span class="line">    amount    <span class="type">int</span> comment <span class="string">&#x27;#购买对应道具的数量&#x27;</span>,</span><br><span class="line">    p_date    string comment <span class="string">&#x27;#登录日期, yyyy-MM-dd&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;角色使用付费元宝购买商城道具时候记录一条&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dm_paid_buy <span class="keyword">values</span></span><br><span class="line">(<span class="number">1234567</span>,<span class="number">120</span>,<span class="number">10098</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">120</span>,<span class="number">10098</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">123</span>,<span class="number">10098</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="string">&#x27;2021-01-02&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">123</span>,<span class="number">10098</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="string">&#x27;2021-01-02&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看表结构</span></span><br><span class="line"><span class="keyword">desc</span> dm_paid_buy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dm_free_buy</span><br><span class="line">(</span><br><span class="line">    `<span class="type">time</span>`    <span class="type">bigint</span> comment <span class="string">&#x27;#购买的时间戳&#x27;</span>,</span><br><span class="line">    server_id string comment <span class="string">&#x27;#服务器ID&#x27;</span>,</span><br><span class="line">    role_id   <span class="type">int</span> comment <span class="string">&#x27;#角色ID&#x27;</span>,</span><br><span class="line">    cost      <span class="type">int</span> comment <span class="string">&#x27;#购买对应道具消耗的免费元宝数量&#x27;</span>,</span><br><span class="line">    item_id   <span class="type">int</span> comment <span class="string">&#x27;#购买对应道具的id&#x27;</span>,</span><br><span class="line">    amount    <span class="type">int</span> comment <span class="string">&#x27;#购买对应道具的数量&#x27;</span>,</span><br><span class="line">    p_date    string comment <span class="string">&#x27;#登录日期, yyyy-MM-dd&#x27;</span></span><br><span class="line">) comment <span class="string">&#x27;角色使用免费元宝购买商城道具时候记录一条&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> dm_free_buy <span class="keyword">values</span></span><br><span class="line">(<span class="number">1234567</span>,<span class="number">123</span>,<span class="number">10098</span>,<span class="number">8</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">123</span>,<span class="number">10098</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">120</span>,<span class="number">10098</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">120</span>,<span class="number">10098</span>,<span class="number">9</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="string">&#x27;2021-01-01&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">123</span>,<span class="number">10098</span>,<span class="number">18</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="string">&#x27;2021-01-02&#x27;</span>),</span><br><span class="line">(<span class="number">1234567</span>,<span class="number">123</span>,<span class="number">10098</span>,<span class="number">7</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="string">&#x27;2021-01-02&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">coalesce</span>(a.p_date, b.p_date)         p_date,</span><br><span class="line">       <span class="built_in">coalesce</span>(a.server_id, b.server_id)   server_id,</span><br><span class="line">       <span class="built_in">coalesce</span>(a.role_id, b.role_id)       role_id,</span><br><span class="line">       round(nvl(a.cost, <span class="number">0</span>) <span class="operator">/</span> b.cost, <span class="number">3</span>) <span class="keyword">as</span> rate</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> p_date, server_id, role_id, <span class="built_in">sum</span>(cost) cost</span><br><span class="line">      <span class="keyword">from</span> dm_paid_buy</span><br><span class="line">      <span class="keyword">where</span> p_date <span class="operator">&gt;=</span> <span class="string">&#x27;2021-01-01&#x27;</span></span><br><span class="line">        <span class="keyword">and</span> p_date <span class="operator">&lt;=</span> <span class="string">&#x27;2021-01-07&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> p_date, server_id, role_id) a</span><br><span class="line"><span class="keyword">full</span> <span class="keyword">join</span> (<span class="keyword">select</span> p_date, server_id, role_id, <span class="built_in">sum</span>(cost) cost</span><br><span class="line">      <span class="keyword">from</span> dm_free_buy</span><br><span class="line">      <span class="keyword">where</span> p_date <span class="operator">&gt;=</span> <span class="string">&#x27;2021-01-01&#x27;</span></span><br><span class="line">        <span class="keyword">and</span> p_date <span class="operator">&lt;=</span> <span class="string">&#x27;2021-01-07&#x27;</span></span><br><span class="line">      <span class="keyword">group</span> <span class="keyword">by</span> p_date, server_id, role_id) b</span><br><span class="line">    <span class="keyword">on</span> a.p_date<span class="operator">=</span>b.p_date <span class="keyword">and</span> a.server_id<span class="operator">=</span>b.server_id <span class="keyword">and</span> a.role_id<span class="operator">=</span>b.role_id;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="join优化"><a href="#join优化" class="headerlink" title="join优化"></a>join优化</h2><h3 id="交通银行-1"><a href="#交通银行-1" class="headerlink" title="交通银行"></a>交通银行</h3><p>数据模型如下：</p>
<p>表T1的数据结构：</p>
<table>
<thead>
<tr>
<th>字段英文名</th>
<th>字段中文名</th>
<th>类型</th>
<th>主键标志</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>Rec_no</td>
<td>记录号</td>
<td>CHAR(3)</td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td>Ci_no</td>
<td>客户号</td>
<td>CHAR(6)</td>
<td>N</td>
<td></td>
</tr>
<tr>
<td>Cust_Type</td>
<td>客户类型</td>
<td>CHAR(2)</td>
<td>N</td>
<td></td>
</tr>
<tr>
<td>Cre_dt</td>
<td>开户日期</td>
<td>Date</td>
<td>N</td>
<td></td>
</tr>
<tr>
<td>Cus_sts</td>
<td>客户状态</td>
<td>Char(1)</td>
<td>N</td>
<td>Y-正常 N-无效</td>
</tr>
</tbody></table>
<p>表T1的数据</p>
<table>
<thead>
<tr>
<th>Rec_no</th>
<th>ci_no</th>
<th>cust_type</th>
<th>cre_dt</th>
<th>cus_sts</th>
</tr>
</thead>
<tbody><tr>
<td>123</td>
<td>111111</td>
<td>01</td>
<td>2010-11-15</td>
<td>Y</td>
</tr>
<tr>
<td>234</td>
<td>222222</td>
<td>02</td>
<td>2011-09-01</td>
<td>Y</td>
</tr>
<tr>
<td>345</td>
<td>333333</td>
<td>02</td>
<td>2012-01-09</td>
<td>Y</td>
</tr>
<tr>
<td>456</td>
<td>444444</td>
<td>01</td>
<td>2012-09-08</td>
<td>Y</td>
</tr>
</tbody></table>
<p>表T2的数据结构：</p>
<table>
<thead>
<tr>
<th>字段英文名</th>
<th>字段中文名</th>
<th>类型</th>
<th>主键标志</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>Ci_no</td>
<td>客户号</td>
<td>CHAR(6)</td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td>AC_no</td>
<td>客户账号</td>
<td>CHAR(9)</td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td>Bal</td>
<td>账号余额</td>
<td>DECIMAL(15，2)</td>
<td>N</td>
<td></td>
</tr>
</tbody></table>
<p>表T2的数据：</p>
<table>
<thead>
<tr>
<th>Ci_no char(6)</th>
<th>Ac_no char(9)</th>
<th>Bal decimal(15,2)</th>
</tr>
</thead>
<tbody><tr>
<td>222222</td>
<td>123456888</td>
<td>1000.28</td>
</tr>
<tr>
<td>222222</td>
<td>123456999</td>
<td>886</td>
</tr>
<tr>
<td>333333</td>
<td>123454321</td>
<td>5000</td>
</tr>
</tbody></table>
<p>请编写sql统计在9月份开户且账户余额不为0的有效客户数。（8分）	</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> T1</span><br><span class="line">(</span><br><span class="line">    rec_no    <span class="type">int</span>,</span><br><span class="line">    ci_no     <span class="type">int</span>,</span><br><span class="line">    cust_type string,</span><br><span class="line">    cre_dt    string,</span><br><span class="line">    cus_sts   string</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> T1 <span class="keyword">values</span></span><br><span class="line">(<span class="number">123</span>,<span class="number">111111</span>,<span class="string">&#x27;01&#x27;</span>,<span class="string">&#x27;2010-11-15&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>),</span><br><span class="line">(<span class="number">234</span>,<span class="number">222222</span>,<span class="string">&#x27;02&#x27;</span>,<span class="string">&#x27;2011-09-01&#x27;</span>,<span class="string">&#x27;N&#x27;</span>),</span><br><span class="line">(<span class="number">345</span>,<span class="number">333333</span>,<span class="string">&#x27;02&#x27;</span>,<span class="string">&#x27;2012-01-09&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>),</span><br><span class="line">(<span class="number">456</span>,<span class="number">444444</span>,<span class="string">&#x27;01&#x27;</span>,<span class="string">&#x27;2012-09-08&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> T2</span><br><span class="line">(</span><br><span class="line">    ci_no     <span class="type">int</span>,</span><br><span class="line">    ac_no string,</span><br><span class="line">    bal    <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> T2 <span class="keyword">values</span></span><br><span class="line">(<span class="number">222222</span>,<span class="string">&#x27;123456789&#x27;</span>,<span class="number">1000.28</span>),</span><br><span class="line">(<span class="number">333333</span>,<span class="string">&#x27;123454321&#x27;</span>,<span class="number">5000.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 传统的写法。</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> t1.ci_no) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">join</span> t2 <span class="keyword">on</span> t1.ci_no<span class="operator">=</span>t2.ci_no</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">month</span>(t1.cre_dt)<span class="operator">=</span><span class="number">9</span></span><br><span class="line"><span class="keyword">and</span> t1.cus_sts<span class="operator">=</span><span class="string">&#x27;Y&#x27;</span></span><br><span class="line"><span class="keyword">and</span> bal<span class="operator">&gt;</span><span class="number">0</span>;</span><br><span class="line"><span class="comment">-- 方案2</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(t1.ci_no) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> <span class="keyword">month</span>(cre_dt)<span class="operator">=</span><span class="number">9</span> <span class="keyword">and</span> cus_sts<span class="operator">=</span><span class="string">&#x27;Y&#x27;</span>) t1</span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> ci_no <span class="keyword">from</span> t2 <span class="keyword">group</span> <span class="keyword">by</span> ci_no <span class="keyword">having</span> <span class="built_in">sum</span>(bal)<span class="operator">&gt;</span><span class="number">0</span>) t2</span><br><span class="line"><span class="keyword">on</span> t1.ci_no<span class="operator">=</span>t2.ci_no;</span><br></pre></td></tr></table></figure>




                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">John Doe</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2022/10/07/sql%E5%8A%A0%E5%BC%BA2/">http://example.com/2022/10/07/sql%E5%8A%A0%E5%BC%BA2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint polocy. If reproduced, please indicate source
                    <a href="/about" target="_blank">John Doe</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/SQL%E5%BC%BA%E5%8C%962/">
                                    <span class="chip bg-color">SQL强化2</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/10/07/%E6%8F%90%E9%AB%98%E7%94%9F%E4%BA%A7%E5%8A%9B%EF%BC%8C%E6%9C%80%E5%85%A8MybatisPlus%E8%AE%B2%E8%A7%A3/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="提高生产力，最全MybatisPlus讲解">
                        
                        <span class="card-title">提高生产力，最全MybatisPlus讲解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            John Doe
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%8F%90%E9%AB%98%E7%94%9F%E4%BA%A7%E5%8A%9B%EF%BC%8C%E6%9C%80%E5%85%A8-MyBatisPlus-%E8%AE%B2%E8%A7%A3%EF%BC%81/">
                        <span class="chip bg-color">提高生产力，最全 MyBatisPlus 讲解！</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/10/07/sql%E5%8A%A0%E5%BC%BA1/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="sql加强1">
                        
                        <span class="card-title">sql加强1</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-10-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            John Doe
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/SQL%E5%BC%BA%E5%8C%961/">
                        <span class="chip bg-color">SQL强化1</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">John Doe</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/lilinzhi666/lilinzhi666.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:3427562614@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3427562614" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3427562614" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
